<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מרכז עזרה - מסעדה+ דבר תורה</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #4a2e1d; /* חום כהה */
            --secondary-color: #7f5539; /* חום בהיר */
            --tertiary-color: #312314; /* חום כהה מאוד לכפתור האתר */
            --background-color: #f7f3e9; /* צבע רקע קרם */
            --text-color: #1a202c; /* צבע טקסט ברירת מחדל */
            --card-bg: #ffffff; /* רקע כרטיס ברירת מחדל */
        }
        body.dark-mode {
            --primary-color: #f0c273; /* חום בהיר למצב כהה */
            --secondary-color: #f0c273; /* זהב בהיר למצב כהה */
            --tertiary-color: #4B3621; /* חום כהה למצב כהה */
            --background-color: #1a1a1a; /* רקע כהה */
            --text-color: #e2e8f0; /* טקסט בהיר למצב כהה */
            --card-bg: #2d3748; /* רקע כרטיס כהה */
        }
        body {
            font-family: 'Heebo', 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            direction: rtl;
            text-align: right;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .shadow-custom {
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to left, var(--secondary-color), var(--primary-color));
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            animation: fadeIn 0.3s ease-in-out;
            color: var(--text-color);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Floating Chat Button (Jack) styles */
        #jack-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        #jack-button:hover {
            transform: scale(1.1);
        }

        /* Chat popup styles */
        #chat-popup {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 350px;
            height: 450px;
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            color: var(--text-color);
        }
        #chat-popup.show {
            transform: translateY(0);
            opacity: 1;
        }

        .chat-popup-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem;
            font-weight: bold;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-log {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            gap: 1rem;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        body.dark-mode .ai-message {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        .loading-dots {
            display: inline-block;
        }
        .loading-dots span {
            animation: bounce 1s infinite;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
        }
        /* New quiz styles */
        .quiz-option {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .quiz-option:hover {
            background-color: #edf2f7;
        }
        .btn-correct {
            background-color: #48bb78;
            color: white;
        }
        .btn-incorrect {
            background-color: #f56565;
            color: white;
        }

        /* Darkened button styles from the separate artifact */
        .dark-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 2.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            background-color: #1a202c; /* צבע כהה מאוד */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            text-decoration: none;
            text-align: center;
        }
        .dark-button:hover {
            background-color: #0d121c; /* צבע כהה עוד יותר בלחיצה */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-background-color text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Theme Toggle Button -->
        <button id="theme-toggle" class="fixed top-4 left-4 p-3 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-md z-50">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:inline"></i>
        </button>
        <!-- Page Header -->
        <header class="bg-secondary-color text-primary-color rounded-[3rem] p-8 mb-8 text-center shadow-2xl transform hover:scale-105 transition-transform duration-500">
            <h1 class="text-3xl md:text-5xl font-extrabold mb-2">מרכז העזרה של <br class="md:hidden">מסעדה+ דבר תורה</h1>
            <p class="text-base md:text-xl font-light">ברוכים הבאים! אנחנו כאן כדי לענות על כל שאלה ולסייע בכל נושא.</p>
        </header>

        <!-- Search Bar -->
        <div class="mb-12 relative">
            <input id="search-input" type="text" placeholder="חפשו שאלות, נושאים, או מוצרים..." class="w-full p-4 pl-12 rounded-full shadow-lg focus:outline-none focus:ring-4 focus:ring-secondary-color focus:border-transparent transition-all duration-300 border-2 border-transparent hover:border-secondary-color" dir="rtl">
            <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-12">
            <!-- All buttons now use the new dark-button class for a unified, darker look -->
            <button id="show-faq-btn" class="w-full md:w-auto dark-button">
                <i class="fas fa-question-circle ml-2"></i> חזרה לשאלות נפוצות
            </button>
            <button id="show-dvar-torah-btn" class="w-full md:w-auto dark-button">
                <i class="fas fa-book-open ml-2"></i> צפה בדבר התורה של פרשת השבוע
            </button>
            <a href="http://67f8a3b706895.site123.me" target="_blank" class="w-full md:w-auto dark-button">
                <i class="fas fa-globe ml-2"></i> בקר באתר האינטרנט של דבר תורה
            </a>
        </div>

        <!-- FAQ Categories (Dynamic Content from Firebase) -->
        <section id="faq-section" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-8 text-gradient">שאלות נפוצות</h2>
            <div id="faq-container" class="space-y-6">
                <!-- FAQ content will be dynamically loaded here by the JavaScript -->
                <p id="loading-message" class="text-center text-gray-500 text-lg">טוען שאלות נפוצות...</p>
            </div>
        </section>

        <!-- Dvar Torah Section -->
        <section id="dvar-torah-section" class="hidden mb-12">
            <h2 id="dvar-torah-title" class="text-3xl font-bold text-center mb-8 text-gradient"></h2>
            <div id="dvar-torah-content" class="bg-card-bg rounded-3xl p-8 shadow-custom">
                <p id="dvar-torah-loading" class="text-center text-gray-500 text-lg">טוען את דבר התורה...<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></p>
            </div>
        </section>

        <div class="w-full h-1 bg-gray-300 rounded-full my-16 opacity-50"></div>

        <!-- Contact Form -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-8 text-gradient">עדיין זקוקים לעזרה?</h2>
            <div class="bg-card-bg rounded-3xl p-8 shadow-custom">
                <p class="text-xl text-center mb-6 text-gray-700 dark:text-gray-300">אם לא מצאתם תשובה לשאלתכם, מלאו את הטופס ונחזור אליכם בהקדם.</p>
                <form id="contact-form" class="space-y-6">
                    <div>
                        <label for="name" class="block mb-2 font-semibold">שם מלא:</label>
                        <input type="text" id="name" name="name" class="w-full p-3 rounded-lg text-gray-800 border-2 border-gray-200 focus:outline-none focus:ring-4 focus:ring-secondary-color/50 transition-all duration-300 dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="email" class="block mb-2 font-semibold">כתובת דוא"ל:</label>
                        <input type="email" id="email" name="email" class="w-full p-3 rounded-lg text-gray-800 border-2 border-gray-200 focus:outline-none focus:ring-4 focus:ring-secondary-color/50 transition-all duration-300 dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="subject" class="block mb-2 font-semibold">נושא:</label>
                        <input type="text" id="subject" name="subject" class="w-full p-3 rounded-lg text-gray-800 border-2 border-gray-200 focus:outline-none focus:ring-4 focus:ring-secondary-color/50 transition-all duration-300 dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="message" class="block mb-2 font-semibold">הודעה:</label>
                        <textarea id="message" name="message" rows="5" class="w-full p-3 rounded-lg text-gray-800 border-2 border-gray-200 focus:outline-none focus:ring-4 focus:ring-secondary-color/50 transition-all duration-300 dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-secondary-color text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-opacity-90 transition-all duration-300">
                        שליחה
                    </button>
                </form>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-500 mt-8 mb-4">
            <p>&copy; 2024 מסעדה+ דבר תורה. כל הזכויות שמורות.</p>
        </footer>
    </div>

    <!-- Modal for form submission status -->
    <div id="modal" class="modal">
        <div class="modal-content text-center">
            <div id="modal-icon" class="text-5xl mb-4"></div>
            <p id="modal-message" class="text-xl font-bold mb-2"></p>
            <p id="modal-sub-message" class="text-gray-600 mb-6"></p>
            <button id="close-modal" class="bg-secondary-color text-white font-bold py-2 px-6 rounded-full shadow-lg hover:bg-opacity-90 transition-all duration-300">סגור</button>
        </div>
    </div>

    <!-- Floating Chat Button (Jack) -->
    <div id="jack-button">
        Jack
    </div>

    <!-- Chat Popup Window -->
    <div id="chat-popup">
        <!-- Chat Header -->
        <div class="chat-popup-header">
            עוזר AI - Jack
            <button id="close-popup" class="text-white">&times;</button>
        </div>
        
        <!-- Chat Log inside Popup -->
        <div id="chat-log-popup" class="chat-log flex-grow p-4 space-y-4 overflow-y-auto flex flex-col-reverse">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area inside Popup -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex flex-col gap-2">
            <div class="flex gap-2 justify-end">
                <button id="generate-faqs-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-2 rounded-full transition-colors duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                    ✨צור שאלות נפוצות
                </button>
                <button id="summarize-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-2 rounded-full transition-colors duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                    ✨סכם שיחה
                </button>
            </div>
            <form id="chat-form-popup" class="flex gap-2">
                <input 
                    type="text" 
                    id="message-input-popup" 
                    placeholder="הקלד את ההודעה שלך..." 
                    class="flex-grow p-2 rounded-lg bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-secondary-color transition-colors duration-200 text-right dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <button 
                    type="submit" 
                    id="send-button-popup"
                    class="bg-secondary-color text-white p-2 rounded-lg hover:bg-opacity-90 transition-colors duration-200 flex-shrink-0">
                    שלח
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDocs, addDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- Setup Firebase and Firestore ---
                const firebaseConfig = {
  apiKey: "AIzaSyAHY8jrJptQE8S6YYN101hb3ovJ9WAUdDY",
  authDomain: "dvartorah-7f9dd.firebaseapp.com",
  projectId: "dvartorah-7f9dd",
  storageBucket: "dvartorah-7f9dd.firebasestorage.app",
  messagingSenderId: "905832021676",
  appId: "1:905832021676:web:02f084bb535ccd29d2a909",
  measurementId: "G-2YVXMYSBCF"
};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const API_KEY = ""; // Canvas will automatically provide the API key
        
        let db;
        let auth;
        let initialFaqs = [];
        let chatHistory = [];
        const maxChatHistory = 10; // To prevent chat history from getting too long

        // --- Quiz Data ---
        const quizData = {
            holidays: {
                title: 'טריוויה על חגים ומועדים ביהדות',
                questions: [
                    {
                        question: 'מהו שמו של החג שבו מציינים את יציאת מצרים?',
                        options: ['ראש השנה', 'פסח', 'סוכות', 'שבועות'],
                        answer: 'פסח'
                    },
                    {
                        question: 'באיזה חג יושבים בסוכה?',
                        options: ['שבועות', 'פורים', 'סוכות', 'חנוכה'],
                        answer: 'סוכות'
                    },
                    {
                        question: 'איזה חג מציין את מתן תורה?',
                        options: ['שבועות', 'פורים', 'יום כיפור', 'ראש השנה'],
                        answer: 'שבועות'
                    }
                ]
            },
            tanakh: {
                title: 'טריוויה על התנ"ך',
                questions: [
                    {
                        question: 'מי היה המנהיג שהוציא את עם ישראל ממצרים?',
                        options: ['אברהם', 'דוד', 'משה', 'שלמה'],
                        answer: 'משה'
                    },
                    {
                        question: 'איזה ספר בתורה מתאר את בריאת העולם?',
                        options: ['שמות', 'בראשית', 'ויקרא', 'במדבר'],
                        answer: 'בראשית'
                    },
                    {
                        question: 'מי היה המלך הראשון של ממלכת ישראל?',
                        options: ['דוד', 'שאול', 'שלמה', 'יהושע'],
                        answer: 'שאול'
                    }
                ]
            }
        };

        let currentQuiz = null;
        let currentQuestionIndex = 0;


        async function initFirebaseAndLoadData() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                                
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                                
                console.log("Firebase authentication successful.");
                await initializeFirestoreData();
                listenForFAQs();

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                const loadingMessageEl = document.getElementById('loading-message');
                if (loadingMessageEl) {
                    loadingMessageEl.textContent = 'אירעה שגיאת התחברות. אנא נסו לרענן את העמוד.';
                }
            }
        }

        async function initializeFirestoreData() {
            const faqsCollectionRef = collection(db, `artifacts/${appId}/public/data/faqs`);
            try {
                const faqsSnapshot = await getDocs(faqsCollectionRef);
                if (faqsSnapshot.empty) {
                    console.log("FAQs collection is empty. Populating with initial data...");
                    const initialData = [
                        { category: "restaurant", categoryTitle: "מסעדה ואירועים", icon: "fas fa-utensils", question: "מהן שעות הפעילות של המסעדה?", answer: "המסעדה פתוחה בין השעות 12:00 בצהריים ועד 22:00 בערב, מראשון עד חמישי." },
                        { category: "restaurant", categoryTitle: "מסעדה ואירועים", icon: "fas fa-utensils", question: "האם יש לכם תפריט כשרות מיוחד?", answer: "כל המנות שלנו כשרות למהדרין בהשגחת הרבנות הראשית." },
                        { category: "dvar-torah", categoryTitle: "דבר תורה שבועי", icon: "fas fa-book-open", question: "האם דברי התורה מתאימים גם לילדים?", answer: "כן, דברי התורה מועברים בשפה קלה ומתאימים לכל המשפחה, כולל ילדים מגיל 6 ומעלה." },
                        { category: "dvar-torah", categoryTitle: "דבר תורה שבועי", icon: "fas fa-book-open", question: "מתי מתקיים השיעור השבועי?", answer: "השיעור מתקיים מדי יום שלישי בשעה 19:00 בחדר ההרצאות במסעדה." },
                        { category: "shop", categoryTitle: "חנות מזכרות וקודש", icon: "fas fa-shopping-bag", question: "אילו מוצרים נמכרים בחנות?", answer: "בחנות תוכלו למצוא מגוון של מזכרות, תשמישי קדושה, וספרי קודש ייחודיים." },
                        { category: "dvar-torah", categoryTitle: "דבר תורה שבועי", icon: "fas fa-book-open", question: "מהי מטרת אתר דבר תורה?", answer: "האתר הוא מיזם של מוסדות בית מדרש דבר תורה ומטרתו להביא את דבר ה' לכל בית יהודי. האתר מכיל סרטונים, דברי תורה כתובים וקישורים לשיעורים שבועיים." },
                        { category: "dvar-torah", categoryTitle: "דבר תורה שבועי", icon: "fas fa-book-open", question: "אילו תכנים ניתן למצוא באתר דבר תורה?", answer: "באתר ניתן למצוא שיעורים מרתקים, דברי תורה מפורשים ומתומצמים, ושיעורים חדשים המועלים מידי שבוע." },
                        { category: "dvar-torah", categoryTitle: "דבר תורה שבועי", icon: "fas fa-book-open", question: "מי אחראי על השיעורים והתכנים באתר?", answer: "השיעורים והתכנים באתר מועברים על ידי הרב יהודה אביטן שליט''א." }
                    ];
                    for (const faq of initialData) {
                        await addDoc(faqsCollectionRef, faq);
                    }
                    console.log("Initial data populated successfully.");
                } else {
                    console.log("FAQs collection already has data. Skipping population.");
                }
            } catch (error) {
                console.error("Error initializing Firestore data:", error);
            }
        }

        function listenForFAQs() {
            const faqsCollectionRef = collection(db, `artifacts/${appId}/public/data/faqs`);
            const q = query(faqsCollectionRef);

            onSnapshot(q, (querySnapshot) => {
                initialFaqs = [];
                querySnapshot.forEach((doc) => {
                    initialFaqs.push({ id: doc.id, ...doc.data() });
                });
                renderFAQs(initialFaqs);
            }, (error) => {
                console.error("Error listening to FAQs:", error);
                const loadingMessageEl = document.getElementById('loading-message');
                if (loadingMessageEl) {
                    loadingMessageEl.textContent = 'שגיאה בטעינת השאלות. אנא נסו שוב מאוחר יותר.';
                }
            });
        }

        function renderFAQs(faqs) {
            const faqContainer = document.getElementById('faq-container');
            const loadingMessageEl = document.getElementById('loading-message');
            faqContainer.innerHTML = '';
            if (loadingMessageEl) {
                loadingMessageEl.style.display = 'none';
            }

            const categories = {};
            faqs.forEach(faq => {
                const category = faq.category;
                if (!categories[category]) {
                    categories[category] = { title: faq.categoryTitle, icon: faq.icon, items: [] };
                }
                categories[category].items.push(faq);
            });

            for (const category in categories) {
                const categoryData = categories[category];
                const cardHtml = `
                    <div class="card bg-card-bg rounded-3xl p-6 shadow-custom hover:shadow-2xl transition-all duration-300">
                        <h3 class="text-2xl font-bold text-secondary-color mb-4 flex items-center gap-2">
                            <i class="${categoryData.icon}"></i> ${categoryData.title}
                        </h3>
                        <div id="faq-${category}" role="list">
                            ${categoryData.items.map((faq, index) => `
                                <div class="border-b border-gray-200 dark:border-gray-700 last:border-b-0">
                                    <button
                                        class="accordion-button w-full text-right py-4 font-semibold text-primary-color flex justify-between items-center"
                                        aria-expanded="false"
                                        aria-controls="panel-${faq.id}"
                                        id="button-${faq.id}">
                                        <span>${faq.question}</span>
                                        <i class="fas fa-chevron-down icon text-lg transition-transform duration-300"></i>
                                    </button>
                                    <div
                                        id="panel-${faq.id}"
                                        role="region"
                                        aria-labelledby="button-${faq.id}"
                                        class="accordion-content p-0 text-gray-600 dark:text-gray-400">
                                        <p class="pb-4">${faq.answer}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                faqContainer.innerHTML += cardHtml;
            }

            addAccordionListeners();
        }

        function handleAccordionClick(event) {
            const button = event.currentTarget;
            const content = button.nextElementSibling;
            const icon = button.querySelector('.icon');
            const isExpanded = button.getAttribute('aria-expanded') === 'true';

            // Close all other open accordions
            document.querySelectorAll('.accordion-button').forEach(btn => {
                if (btn !== button && btn.getAttribute('aria-expanded') === 'true') {
                    btn.setAttribute('aria-expanded', 'false');
                    btn.nextElementSibling.style.maxHeight = '0px';
                    btn.nextElementSibling.style.padding = '0';
                    btn.querySelector('.icon').style.transform = 'rotate(0deg)';
                }
            });

            // Toggle the clicked accordion
            if (!isExpanded) {
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.padding = '1rem 0';
                icon.style.transform = 'rotate(180deg)';
                button.setAttribute('aria-expanded', 'true');
            } else {
                content.style.maxHeight = '0px';
                content.style.padding = '0';
                icon.style.transform = 'rotate(0deg)';
                button.setAttribute('aria-expanded', 'false');
            }
        }

        function addAccordionListeners() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                button.removeEventListener('click', handleAccordionClick);
                button.addEventListener('click', handleAccordionClick);
            });
        }

        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const filteredFaqs = initialFaqs.filter(faq => 
                faq.question.toLowerCase().includes(searchTerm) || 
                faq.answer.toLowerCase().includes(searchTerm)
            );
            renderFAQs(filteredFaqs);
        }

        function showModal(message, subMessage, type) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const modalSubMessage = document.getElementById('modal-sub-message');
            const modalIcon = document.getElementById('modal-icon');

            modalMessage.textContent = message;
            modalSubMessage.textContent = subMessage;
                        
            if (type === 'success') {
                modalIcon.innerHTML = `<i class="fas fa-check-circle text-green-500"></i>`;
            } else if (type === 'error') {
                modalIcon.innerHTML = `<i class="fas fa-times-circle text-red-500"></i>`;
            }

            modal.style.display = 'flex';
        }

        // --- Theme Toggling Logic ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateIcons(isDarkMode);
        }

        function updateIcons(isDarkMode) {
            const moonIcon = document.querySelector('#theme-toggle .fa-moon');
            const sunIcon = document.querySelector('#theme-toggle .fa-sun');
            if (isDarkMode) {
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
        }

        // On initial load, apply saved theme or system preference
        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDark);
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
            updateIcons(isDarkMode);
        }

        // --- AI Assistant Logic ---
        const jackButton = document.getElementById('jack-button');
        const chatPopup = document.getElementById('chat-popup');
        const closePopupBtn = document.getElementById('close-popup');
        const chatFormPopup = document.getElementById('chat-form-popup');
        const chatLogPopup = document.getElementById('chat-log-popup');
        const messageInputPopup = document.getElementById('message-input-popup');
        const summarizeBtn = document.getElementById('summarize-btn');
        const generateFaqsBtn = document.getElementById('generate-faqs-btn');

        let isFirstMessage = true;
        let isQuizActive = false;
        let quizOptionsContainer = null;

        if (jackButton && chatPopup) {
            jackButton.addEventListener('click', () => {
                chatPopup.classList.toggle('show');
                if (chatPopup.classList.contains('show')) {
                    messageInputPopup.focus();
                }
            });

            closePopupBtn.addEventListener('click', () => {
                chatPopup.classList.remove('show');
            });
        }
        
        if (chatPopup) {
            chatPopup.addEventListener('transitionend', () => {
                if (chatPopup.classList.contains('show') && isFirstMessage) {
                    appendMessage('שלום! שמי ג׳ק, עוזר ה-AI של דבר תורה. אני בקיא במיוחד ביהדות, בחגים ובתנ"ך. כיצד אוכל לעזור לך?', 'ai');
                    isFirstMessage = false;
                }
            });
        }

        if (chatFormPopup) {
            chatFormPopup.addEventListener('submit', function(event) {
                event.preventDefault();
                handleChatMessage();
            });
        }

        if (summarizeBtn) {
            summarizeBtn.addEventListener('click', () => handleAiFeature('summarize'));
        }

        if (generateFaqsBtn) {
            generateFaqsBtn.addEventListener('click', () => handleAiFeature('generate-faqs'));
        }

        async function handleAiFeature(feature) {
            const conversation = chatHistory.map(entry => `${entry.role}: ${entry.text}`).join('\n');
            let prompt = '';
            let promptIntro = '';

            if (conversation.trim() === '') {
                appendMessage('אין מספיק תוכן לסכם או ליצור שאלות נפוצות. אנא התחל שיחה.', 'ai');
                return;
            }

            switch(feature) {
                case 'summarize':
                    prompt = `סכם את השיחה הבאה בנקודות תמציתיות ובשפה פשוטה. השיחה היא: \n\n${conversation}`;
                    promptIntro = 'מסכם את השיחה...';
                    break;
                case 'generate-faqs':
                    prompt = `על בסיס השיחה הבאה, זהה שאלות נפוצות רלוונטיות ואת התשובות עליהן. תן את התוצאה כרשימה ממוספרת של זוגות שאלה-תשובה. השיחה היא: \n\n${conversation}`;
                    promptIntro = 'מזהה שאלות נפוצות...';
                    break;
            }

            const loadingMessageElement = appendMessage(promptIntro + '<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>', 'ai', true);
            
            const systemPrompt = `אתה עוזר AI בשם ג'ק שנוצר על ידי גוגל. אתה מספק מידע באופן מדויק וענייני. נסח את התשובות שלך בעברית, בשפה פשוטה וידידותית.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            
            const generatedResponse = await getGeminiResponse(payload);
            loadingMessageElement.remove();
            
            appendMessage(generatedResponse, 'ai');
        }

        async function getGeminiResponse(payload) {
            const apiUrl = `${GEMINI_API_URL}${API_KEY}`;
            
            let retryCount = 0;
            const maxRetries = 3;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retryCount++;
                        await delay(Math.pow(2, retryCount) * 1000); // Exponential backoff
                        continue;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        return generatedText;
                    } else {
                        console.error("Gemini API returned no candidates:", result);
                        return "שגיאה: לא התקבלה תגובה מה-AI.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return "שגיאה: לא ניתן ליצור קשר עם ה-AI.";
                }
            }
            return "שגיאה: ניסיונות חוזרים כשלו.";
        }

        async function handleChatMessage() {
            const userMessage = messageInputPopup.value.trim();
            if (userMessage === '') return;
            
            // Check for specific quiz commands
            if (userMessage.includes('טריוויה')) {
                const topic = userMessage.includes('חגים') ? 'holidays' : 'tanakh';
                startQuiz(topic);
                messageInputPopup.value = '';
                return;
            }
            
            if (isQuizActive) {
                appendMessage(userMessage, 'user');
                const quizMessageElement = appendMessage('ענה על השאלה באמצעות הכפתורים למטה.', 'ai');
                if (quizOptionsContainer) {
                    quizMessageElement.appendChild(quizOptionsContainer);
                }
                messageInputPopup.value = '';
                return;
            }
            
            appendMessage(userMessage, 'user');
            
            // Add to chat history
            chatHistory.push({ role: 'user', text: userMessage });
            if (chatHistory.length > maxChatHistory) {
                chatHistory.shift();
            }

            messageInputPopup.value = '';

            const loadingMessageElement = appendMessage('<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>', 'ai', true);

            try {
                // First, check Firestore for an answer
                const firestoreResponse = await findAnswerInFirestore(userMessage);

                if (firestoreResponse) {
                    loadingMessageElement.remove();
                    appendMessage(firestoreResponse, 'ai');
                } else {
                    // If no Firestore answer, try the Gemini API with search grounding
                    const geminiResponse = await getGeminiResponseWithSearch(userMessage);
                    loadingMessageElement.remove();

                    if (geminiResponse) {
                        appendMessage(geminiResponse, 'ai');
                    } else {
                        appendMessage('לא מצאתי תשובה מתאימה לשאלתך. אנא נסה לשאול בדרך אחרת או שלח לנו פנייה דרך הטופס.', 'ai');
                    }
                }
            } catch (error) {
                console.error("Error finding AI response:", error);
                loadingMessageElement.remove();
                appendMessage('אירעה שגיאה. אנא נסה שוב מאוחר יותר.', 'ai');
            }
        }

        async function getGeminiResponseWithSearch(userQuery) {
            const systemPrompt = `
                אתה עוזר AI בשם ג'ק שנוצר על ידי גוגל. אתה בקיא במיוחד בתכנים יהודיים, בתנ"ך, בחגים ומועדים ובידע כללי רחב.
                כאשר אתה נשאל שאלות, השב תשובות מפורטות, רהוטות, ומעניינות, תוך שימוש בידע שלך ובמקורות מידע אמינים מהאינטרנט. 
                נסח את התשובות שלך בעברית, בשפה פשוטה וידידותית, כפי שמורה ידען ומלומד.
            `;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const apiUrl = `${GEMINI_API_URL}${API_KEY}`;
            let retryCount = 0;
            const maxRetries = 3;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retryCount++;
                        await delay(Math.pow(2, retryCount) * 1000);
                        continue;
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        return text;
                    } else {
                        console.error("Gemini API returned no candidates with search for Dvar Torah:", result);
                        return null;
                    }
                } catch (error) {
                    console.error("Error calling Gemini API with search for Dvar Torah:", error);
                    return null;
                }
            }
            return "שגיאה: ניסיונות חוזרים כשלו.";
        }

        /**
         * Searches Firestore for a relevant FAQ.
         * @param {string} query The user's query.
         * @returns {Promise<string|null>} The answer or null if not found.
         */
        async function findAnswerInFirestore(query) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return null;
            }

            const faqsCollectionRef = collection(db, `artifacts/${appId}/public/data/faqs`);

            const lowerCaseQuery = query.toLowerCase();
            const matchingFaqs = initialFaqs.filter(faq => 
                faq.question.toLowerCase().includes(lowerCaseQuery)
            );

            if (matchingFaqs.length > 0) {
                return matchingFaqs[0].answer;
            }
            return null;
        }
        
        // --- Quiz Logic ---
        function startQuiz(topic) {
            currentQuiz = quizData[topic];
            currentQuestionIndex = 0;
            isQuizActive = true;
            appendMessage(`בואו נתחיל בטריוויה על ${currentQuiz.title}!`, 'ai');
            loadQuizQuestion();
        }

        function loadQuizQuestion() {
            const questionData = currentQuiz.questions[currentQuestionIndex];
            const messageText = `שאלה #${currentQuestionIndex + 1}: ${questionData.question}`;
            
            const messageElement = appendMessage(messageText, 'ai');
            
            const optionsDiv = document.createElement('div');
            optionsDiv.classList.add('flex', 'flex-col', 'gap-2', 'mt-4');
            quizOptionsContainer = optionsDiv; // Keep a reference to the container

            questionData.options.forEach(option => {
                const optionElement = document.createElement('button');
                optionElement.classList.add('quiz-option');
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => checkAnswer(option, questionData.answer, optionsDiv));
                optionsDiv.appendChild(optionElement);
            });

            messageElement.appendChild(optionsDiv);
            chatLogPopup.scrollTop = chatLogPopup.scrollHeight;
        }

        function checkAnswer(selectedOption, correctAnswer, optionsContainer) {
            const allOptions = optionsContainer.querySelectorAll('.quiz-option');
            let isCorrect = selectedOption === correctAnswer;
            let resultMessage = '';

            allOptions.forEach(opt => {
                opt.disabled = true;
                if (opt.textContent === correctAnswer) {
                    opt.classList.add('btn-correct');
                } else {
                    opt.classList.add('btn-incorrect');
                }
            });

            if (isCorrect) {
                resultMessage = 'תשובה נכונה! כל הכבוד.';
            } else {
                resultMessage = `תשובה לא נכונה. התשובה הנכונה היא: ${correctAnswer}`;
            }

            appendMessage(resultMessage, 'ai');

            const nextBtn = document.createElement('button');
            nextBtn.classList.add('btn', 'mt-4');
            nextBtn.textContent = 'שאלה הבאה';
            nextBtn.addEventListener('click', () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < currentQuiz.questions.length) {
                    loadQuizQuestion();
                } else {
                    appendMessage('סיימת את כל השאלות בנושא זה! בחר נושא אחר או חזור על השאלות.', 'ai');
                    isQuizActive = false;
                    currentQuiz = null;
                }
            }, { once: true });
            
            appendMessage('', 'ai').appendChild(nextBtn);
        }

        function appendMessage(text, sender, isHtml = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add(
                'message', 
                'shadow-sm', 
                'transition-all', 
                'duration-300', 
                'ease-in-out', 
                'p-3'
            );

            if (sender === 'user') {
                messageElement.classList.add('user-message', 'ml-auto');
                messageElement.style.direction = 'rtl';
                messageElement.style.textAlign = 'right';
            } else {
                messageElement.classList.add('ai-message', 'mr-auto');
                messageElement.style.direction = 'rtl';
                messageElement.style.textAlign = 'right';
            }

            if (isHtml) {
                messageElement.innerHTML = text;
            } else {
                messageElement.textContent = text;
            }

            if (chatLogPopup) {
                chatLogPopup.appendChild(messageElement);
                chatLogPopup.scrollTop = chatLogPopup.scrollHeight;
            }

            return messageElement;
        }

        // --- Dvar Torah Logic ---
        const showFaqBtn = document.getElementById('show-faq-btn');
        const showDvarTorahBtn = document.getElementById('show-dvar-torah-btn');
        const faqSection = document.getElementById('faq-section');
        const dvarTorahSection = document.getElementById('dvar-torah-section');
        const dvarTorahTitle = document.getElementById('dvar-torah-title');
        const dvarTorahContent = document.getElementById('dvar-torah-content');
        const dvarTorahLoading = document.getElementById('dvar-torah-loading');

        showFaqBtn.addEventListener('click', () => {
            faqSection.classList.remove('hidden');
            dvarTorahSection.classList.add('hidden');
        });

        showDvarTorahBtn.addEventListener('click', async () => {
            faqSection.classList.add('hidden');
            dvarTorahSection.classList.remove('hidden');
            dvarTorahLoading.classList.remove('hidden');
            dvarTorahTitle.textContent = 'טוען דבר תורה...';
            dvarTorahContent.innerHTML = `<p id="dvar-torah-loading" class="text-center text-gray-500 text-lg">טוען את דבר התורה...<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></p>`;

            const dvarTorahText = await getDvarTorah();

            if (dvarTorahText) {
                dvarTorahLoading.classList.add('hidden');
                dvarTorahContent.innerHTML = `<p>${dvarTorahText}</p>`;
            } else {
                dvarTorahLoading.classList.remove('hidden');
                dvarTorahContent.innerHTML = `<p class="text-center text-red-500 text-lg">אירעה שגיאה בטעינת דבר התורה. אנא נסו שוב מאוחר יותר.</p>`;
            }
        });

        async function getDvarTorah() {
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth() + 1; // Months are 0-indexed
            const year = today.getFullYear();
            const formattedDate = `${day}/${month}/${year}`;

            // Use Google Search to find the current weekly Torah portion
            const systemPrompt = `
                אתה מומחה ביהדות. המטרה שלך היא למצוא את פרשת השבוע הנוכחית על פי התאריך העברי/לועזי של היום ולכתוב עליה דבר תורה קצר ומרתק.
                הטקסט שתכתוב צריך להיות בסגנון קליל, מתאים לכל המשפחה, ולכלול מסר חינוכי או רעיון עמוק שקשור לפרשה.
                הטקסט צריך להיות באורך של 200-300 מילים. השתמש בידע שלך ובמידע מהאינטרנט.
            `;
            const userQuery = `כתוב דבר תורה על פרשת השבוע הנוכחית (היום הוא ${formattedDate}). במידה ויש חג יהודי קרוב, כתוב גם על החג.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const apiUrl = `${GEMINI_API_URL}${API_KEY}`;
            let retryCount = 0;
            const maxRetries = 3;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retryCount++;
                        await delay(Math.pow(2, retryCount) * 1000);
                        continue;
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        return text;
                    } else {
                        console.error("Gemini API returned no candidates with search for Dvar Torah:", result);
                        return null;
                    }
                } catch (error) {
                    console.error("Error calling Gemini API with search for Dvar Torah:", error);
                    return null;
                }
            }
            return null;
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!db) {
                        showModal('אירעה שגיאה בשליחה.', 'אנא נסו שוב מאוחר יותר.', 'error');
                        return;
                    }
                                        
                    const ticketsCollectionRef = collection(db, `artifacts/${appId}/public/data/tickets`);
                                        
                    try {
                        const newTicketData = {
                            name: document.getElementById('name').value,
                            email: document.getElementById('email').value,
                            subject: document.getElementById('subject').value,
                            message: document.getElementById('message').value,
                            timestamp: new Date().toISOString(),
                            status: 'חדשה'
                        };

                        const docRef = await addDoc(ticketsCollectionRef, newTicketData);
                        console.log("Ticket created with ID: ", docRef.id);

                        showModal('הפנייה נשלחה בהצלחה!', `מספר הפנייה שלך הוא: ${docRef.id}.`, 'success');
                        contactForm.reset();
                    } catch (error) {
                        console.error("Error adding document:", error);
                        showModal('אירעה שגיאה בשליחה.', 'אנא נסו שוב מאוחר יותר.', 'error');
                    }
                });
            }

            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', handleSearch);

            const closeModalButton = document.getElementById('close-modal');
            closeModalButton.addEventListener('click', () => {
                document.getElementById('modal').style.display = 'none';
            });

            const themeToggleButton = document.getElementById('theme-toggle');
            themeToggleButton.addEventListener('click', toggleTheme);

            applyInitialTheme();
            initFirebaseAndLoadData();
        });
    </script>
</body>
</html>
