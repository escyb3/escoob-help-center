<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תיאטרון כוית ומופסון</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e9;
            color: #333;
        }

        /* Gradient for buttons and cards */
        .gradient-background {
            background: linear-gradient(145deg, #a77756, #d49a75);
        }

        .gradient-text {
            background-image: linear-gradient(145deg, #a77756, #d49a75);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d49a75;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a77756;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 700px;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .view.hidden {
            display: none;
        }

        /* Seat styles */
        .seat {
            width: 30px;
            height: 30px;
            background-color: #ccc;
            border-radius: 5px;
            margin: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #333;
            transition: background-color 0.2s, transform 0.2s;
        }

        .seat:hover {
            transform: scale(1.1);
        }

        .seat.available {
            background-color: #d49a75;
            color: white;
        }

        .seat.selected {
            background-color: #a77756;
            transform: scale(1.1);
            position: relative;
        }

        .seat.selected::after {
            content: '✔';
            position: absolute;
            font-size: 16px;
            color: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .seat.reserved {
            background-color: #666;
            cursor: not-allowed;
        }

        #stage {
            width: 100%;
            height: 60px;
            background-color: #333;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .showtime-button {
            transition: all 0.2s;
        }
    </style>
</head>

<body class="bg-[#f7f3e9] flex flex-col items-center p-4 min-h-screen">
    <div class="max-w-6xl w-full">

        <!-- Header and Auth Section -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 p-4 bg-white rounded-xl shadow-md">
            <h1 class="text-4xl font-bold gradient-text text-center md:text-right mb-4 md:mb-0">
                תיאטרון כוית ומופסון
            </h1>
            <div id="auth-controls" class="flex items-center space-x-2 space-x-reverse text-sm font-medium text-gray-700">
                <div id="logged-in-state" class="hidden flex items-center space-x-2 space-x-reverse">
                    <span id="user-info" class="text-center md:text-right">שלום, משתמש</span>
                    <button id="logout-button" class="py-1 px-3 rounded-md text-white text-xs gradient-background hover:opacity-90 transition-opacity">
                        התנתק
                    </button>
                </div>
                <div id="logged-out-state">
                    <button id="login-button" class="py-1 px-3 rounded-md text-white text-xs gradient-background hover:opacity-90 transition-opacity">
                        התחבר / הירשם
                    </button>
                </div>
            </div>
            <nav class="flex space-x-4 space-x-reverse mt-4 md:mt-0">
                <button onclick="navigateTo('home')" class="py-2 px-4 rounded-md text-white font-medium gradient-background hover:opacity-90 transition-opacity">
                    הצגות
                </button>
                <button onclick="navigateTo('my-orders')" class="py-2 px-4 rounded-md text-white font-medium gradient-background hover:opacity-90 transition-opacity">
                    ההזמנות שלי
                </button>
                <button id="admin-dashboard-btn" onclick="navigateTo('admin-dashboard')" class="py-2 px-4 rounded-md text-white font-medium gradient-background hover:opacity-90 transition-opacity hidden">
                    לוח בקרה למנהל
                </button>
            </nav>
        </header>

        <!-- Main content area -->
        <main class="w-full">
            <!-- Home View (default) -->
            <div id="home-view" class="view">
                <div class="text-lg text-gray-700 mb-8 p-4 bg-white rounded-xl shadow-md">
                    <p>
                        תיאטרון כוית ומופסון הוקם מבית חברת אסקוב בע"מ בשנת 2020. אנו מציגים מגוון רחב של הצגות איכותיות.
                    </p>
                    <p class="mt-4">
                        ברוכים הבאים לאתר התיאטרון שלנו! כאן תוכלו לראות את לוח ההצגות העדכני ולהזמין כרטיסים.
                    </p>
                </div>

                <!-- Recommended Plays Section -->
                <section id="recommended-plays-section" class="hidden">
                    <h2 class="text-2xl font-bold gradient-text mb-4 text-center">הצגות מומלצות עבורך</h2>
                    <div id="recommended-plays-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Recommended play cards will be inserted here -->
                    </div>
                </section>

                <!-- Search and Filter Section -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0 md:space-x-4 md:space-x-reverse p-4 bg-white rounded-xl shadow-md">
                    <input type="text" id="search-input" placeholder="חיפוש הצגה..." class="w-full md:w-1/2 rounded-md p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <select id="filter-select" class="w-full md:w-auto rounded-md p-2 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="all">כל הסוגים</option>
                        <option value="קומדיה">קומדיה</option>
                        <option value="דרמה">דרמה</option>
                        <option value="ילדים">ילדים</option>
                        <option value="מוזיקלי">מוזיקלי</option>
                    </select>
                </div>

                <!-- Plays Section -->
                <section>
                    <h2 class="text-2xl font-bold gradient-text mb-4 text-center">כל ההצגות</h2>
                    <div id="events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cards will be dynamically inserted here by JavaScript -->
                    </div>
                </section>
            </div>

            <!-- My Orders View (hidden by default) -->
            <div id="my-orders-view" class="view hidden">
                <h2 class="text-2xl font-bold gradient-text mb-6 text-center">ההזמנות שלי</h2>
                <div id="orders-container" class="space-y-4">
                    <!-- Orders will be dynamically inserted here -->
                </div>
            </div>

            <!-- Admin Dashboard View (hidden by default) -->
            <div id="admin-dashboard-view" class="view hidden">
                <h2 class="text-2xl font-bold gradient-text mb-6 text-center">לוח בקרה למנהל</h2>
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">דוח מכירות</h3>
                    <div id="sales-report">
                        <p><strong>סה"כ הזמנות:</strong> <span id="total-orders">0</span></p>
                        <p><strong>סה"כ הכנסות:</strong> <span id="total-revenue">0</span> ₪</p>
                        <p><strong>הצגה נמכרת ביותר:</strong> <span id="best-selling-play">אין נתונים</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">ניהול הצגות</h3>
                    <button id="add-play-btn" class="py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white gradient-background hover:opacity-90">הוסף הצגה חדשה</button>
                    <div id="admin-plays-list" class="mt-4 space-y-4">
                        <!-- Admin play cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Payment View -->
            <div id="payment-view" class="view hidden">
                <h2 class="text-2xl font-bold gradient-text mb-6 text-center">תשלום עבור ההזמנה</h2>
                <div id="payment-card" class="bg-white p-6 rounded-xl shadow-md max-w-md mx-auto">
                    <div id="payment-details" class="mb-4 text-right">
                        <p><strong>הצגה:</strong> <span id="payment-play-title"></span></p>
                        <p><strong>מועד:</strong> <span id="payment-showtime-text"></span></p>
                        <p><strong>סה"כ לתשלום:</strong> <span id="payment-total-price"></span> ₪</p>
                    </div>
                    <form id="payment-form" class="space-y-4">
                        <div>
                            <label for="card-number" class="block text-sm font-medium text-gray-700">מספר כרטיס</label>
                            <input type="text" id="card-number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="xxxx-xxxx-xxxx-xxxx">
                        </div>
                        <div class="flex space-x-4 space-x-reverse">
                            <div class="flex-1">
                                <label for="card-expiry" class="block text-sm font-medium text-gray-700">תוקף</label>
                                <input type="text" id="card-expiry" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="MM/YY">
                            </div>
                            <div class="flex-1">
                                <label for="card-cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                                <input type="text" id="card-cvv" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="xxx">
                            </div>
                        </div>
                        <div id="payment-message" class="mt-2 text-sm font-medium text-red-500 text-center"></div>
                        <button type="submit" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white gradient-background">
                            שלם עכשיו
                        </button>
                    </form>
                </div>
            </div>
        </main>

        <!-- Auth Modal -->
        <div id="auth-modal" class="modal">
            <div class="modal-content text-center max-w-sm">
                <span class="close-button" onclick="closeModal('auth-modal')">&times;</span>
                <h3 id="auth-modal-title" class="text-2xl font-semibold gradient-text mb-4">התחברות נדרשת</h3>
                <p class="text-gray-600 mb-6">כדי להזמין כרטיסים או לצפות בהצגות, אנא התחבר או הירשם.</p>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-gray-700">דוא"ל</label>
                        <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-gray-700">סיסמה</label>
                        <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div id="auth-message" class="mt-2 text-sm font-medium text-red-500"></div>
                    <button type="submit" id="auth-submit-button" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white gradient-background">התחבר</button>
                </form>
                <button id="toggle-auth-mode" class="mt-4 text-sm text-gray-500 underline">אין לך חשבון? הירשם</button>
            </div>
        </div>

        <!-- Booking Modal - Stage 1: Showtime Selection, Stage 2: Seat Selection -->
        <div id="booking-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('booking-modal')">&times;</span>
                <h2 id="modal-play-title" class="text-2xl font-semibold gradient-text mb-4 text-center"></h2>

                <!-- Stage 1: Showtime Selection -->
                <div id="showtime-selection-stage">
                    <p class="text-center text-gray-600 mb-4 font-medium">בחר מועד להצגה:</p>
                    <div id="showtimes-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-80 overflow-y-auto p-2">
                        <!-- Showtimes will be dynamically generated here -->
                    </div>
                    <div id="showtime-error" class="text-center text-red-500 mt-4 hidden"></div>
                </div>

                <!-- Stage 2: Seat Selection -->
                <div id="seat-selection-stage" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center border-b pb-2">
                        <span id="selected-showtime-display"></span> - בחירת מושבים
                    </h3>
                    <div id="seating-map" class="flex flex-col items-center p-4 bg-gray-100 rounded-lg">
                        <div id="stage">במה</div>
                        <div id="seat-rows" class="flex flex-col items-center">
                            <!-- Seats will be dynamically generated here -->
                        </div>
                        <div id="seat-selection-summary" class="mt-4 text-center font-bold text-gray-700">
                            <p>סה"כ מושבים שנבחרו: <span id="selected-seats-count">0</span></p>
                            <p>סה"כ לתשלום: <span id="selected-seats-price">0</span> ₪</p>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button id="back-to-showtimes" class="py-2 px-6 rounded-md shadow-sm text-sm font-medium text-gray-600 bg-gray-200 hover:bg-gray-300">
                            חזור למועדים
                        </button>
                        <button id="proceed-to-payment" class="py-2 px-6 rounded-md shadow-sm text-sm font-medium text-white gradient-background hover:opacity-90">
                            המשך לתשלום
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Booking Confirmation Modal -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content text-center max-w-sm">
                <h3 class="text-2xl font-semibold gradient-text mb-4">הזמנה אושרה!</h3>
                <p class="text-lg font-medium mb-2">תודה על הזמנתך.</p>
                <div id="confirmation-details" class="bg-gray-100 p-4 rounded-lg mt-4 text-right">
                    <p><strong>הצגה:</strong> <span id="conf-play-title"></span></p>
                    <p><strong>מועד:</strong> <span id="conf-showtime"></span></p>
                    <p><strong>מספר כרטיסים:</strong> <span id="conf-tickets"></span></p>
                    <p><strong>שם:</strong> <span id="conf-name"></span></p>
                    <p><strong>דוא"ל:</strong> <span id="conf-email"></span></p>
                    <p><strong>מושבים:</strong> <span id="conf-seats"></span></p>
                    <p class="mt-2 text-sm text-gray-500"><strong>מספר הזמנה:</strong> <span id="conf-booking-id"></span></p>
                </div>
                <button onclick="closeModal('confirmation-modal')" class="mt-6 py-2 px-6 rounded-md shadow-sm text-sm font-medium text-white gradient-background">סגור</button>
            </div>
        </div>

        <!-- Add/Edit Play Modal -->
        <div id="play-form-modal" class="modal">
            <div class="modal-content max-w-xl">
                <span class="close-button" onclick="closeModal('play-form-modal')">&times;</span>
                <h3 id="play-form-title" class="text-2xl font-semibold gradient-text mb-4"></h3>
                <form id="play-form" class="space-y-4">
                    <!-- Basic Play Info Inputs -->
                    <div>
                        <label for="play-title-input" class="block text-sm font-medium text-gray-700">שם הצגה</label>
                        <input type="text" id="play-title-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="play-description-input" class="block text-sm font-medium text-gray-700">תיאור</label>
                        <textarea id="play-description-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"></textarea>
                    </div>
                    <div class="flex space-x-4 space-x-reverse">
                        <div class="flex-1">
                            <label for="play-type-input" class="block text-sm font-medium text-gray-700">סוג</label>
                            <select id="play-type-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option value="קומדיה">קומדיה</option>
                                <option value="דרמה">דרמה</option>
                                <option value="ילדים">ילדים</option>
                                <option value="מוזיקלי">מוזיקלי</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="play-price-input" class="block text-sm font-medium text-gray-700">מחיר</label>
                            <input type="number" id="play-price-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                    <div>
                        <label for="play-image-input" class="block text-sm font-medium text-gray-700">כתובת תמונה</label>
                        <input type="url" id="play-image-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="https://example.com/image.jpg">
                    </div>

                    <!-- Showtime Management (Admin only) -->
                    <h4 class="text-lg font-semibold border-t pt-4 mt-4">ניהול מועדים</h4>
                    <div id="showtimes-admin-container" class="space-y-3 p-3 border rounded-lg bg-gray-50">
                        <!-- Existing showtimes will be dynamically loaded here -->
                    </div>
                    <button type="button" id="add-showtime-btn" class="py-1 px-3 rounded-md shadow-sm text-xs font-medium text-white bg-green-500 hover:bg-green-600">
                        + הוסף מועד
                    </button>

                    <div id="play-form-message" class="text-sm font-medium text-red-500"></div>
                    <button type="submit" class="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white gradient-background">שמור הצגה</button>
                </form>
            </div>
        </div>

        <!-- General Message Modal (replaces alert/confirm) -->
        <div id="message-modal" class="modal">
            <div class="modal-content max-w-sm">
                <p id="modal-text" class="text-center text-lg font-medium"></p>
                <div class="mt-4 flex justify-center">
                    <button onclick="closeModal('message-modal')" class="py-2 px-6 rounded-md shadow-sm text-sm font-medium text-white gradient-background">סגור</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyBJi_DPggnBRL4FkdIW2xC6eGdH5NtHOZ4",
            authDomain: "theater-escoob.firebaseapp.com",
            projectId: "theater-escoob",
            storageBucket: "theater-escoob.firebasestorage.app",
            messagingSenderId: "381106635334",
            appId: "1:381106635334:web:32f247f3ca7348229e8047",
            measurementId: "G-G7JNK4N0VK"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, serverTimestamp, query, where, getDocs, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances and state
        let app, db, auth;
        let userId = null;
        let isAdmin = false;
        let allPlays = [];
        let authMode = 'login'; // 'login' or 'signup'
        let currentBooking = {
            playId: null,
            playTitle: null,
            showtimeId: null,
            showtimeText: null,
            selectedSeats: []
        };
        let playInEdit = null; // Used for admin modal

        // Expose functions to the global scope for event handlers
        window.openBookingModal = openBookingModal;
        window.openPlayFormModal = openPlayFormModal;
        window.deletePlay = deletePlay;
        window.closeModal = closeModal;
        window.navigateTo = navigateTo;
        window.selectShowtime = selectShowtime;
        window.toggleSeatSelection = toggleSeatSelection;
        window.updateShowtimeDateTime = updateShowtimeDateTime;
        window.removeShowtime = removeShowtime;


        // UI Elements (Re-using some, adding new ones)
        const loggedInStateEl = document.getElementById('logged-in-state');
        const loggedOutStateEl = document.getElementById('logged-out-state');
        const userInfoEl = document.getElementById('user-info');
        const homeView = document.getElementById('home-view');
        const myOrdersView = document.getElementById('my-orders-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');
        const paymentView = document.getElementById('payment-view');
        const eventsContainer = document.getElementById('events-container');
        const ordersContainer = document.getElementById('orders-container');
        const searchInput = document.getElementById('search-input');
        const filterSelect = document.getElementById('filter-select');
        const bookingModalEl = document.getElementById('booking-modal');
        const confirmationModalEl = document.getElementById('confirmation-modal');
        const messageModalEl = document.getElementById('message-modal');
        const modalPlayTitleEl = document.getElementById('modal-play-title');
        const proceedToPaymentBtn = document.getElementById('proceed-to-payment');
        const paymentForm = document.getElementById('payment-form');
        const paymentMessageEl = document.getElementById('payment-message');
        const paymentPlayTitleEl = document.getElementById('payment-play-title');
        const paymentTotalPriceEl = document.getElementById('payment-total-price');
        const paymentShowtimeTextEl = document.getElementById('payment-showtime-text');
        const showtimeSelectionStage = document.getElementById('showtime-selection-stage');
        const seatSelectionStage = document.getElementById('seat-selection-stage');
        const showtimesContainer = document.getElementById('showtimes-container');
        const backToShowtimesBtn = document.getElementById('back-to-showtimes');
        const selectedShowtimeDisplay = document.getElementById('selected-showtime-display');

        const authModalEl = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');

        const recommendedPlaysSection = document.getElementById('recommended-plays-section');
        const adminDashboardBtn = document.getElementById('admin-dashboard-btn');
        const playForm = document.getElementById('play-form');
        const playFormTitle = document.getElementById('play-form-title');
        const playFormModal = document.getElementById('play-form-modal');
        const playFormMessageEl = document.getElementById('play-form-message');
        const playTitleInput = document.getElementById('play-title-input');
        const playDescriptionInput = document.getElementById('play-description-input');
        const playTypeInput = document.getElementById('play-type-input');
        const playPriceInput = document.getElementById('play-price-input');
        const playImageInput = document.getElementById('play-image-input');
        const loginButton = document.getElementById('login-button');

        const ADMIN_EMAIL = 'admin@example.com';
        const SEATS_PER_ROW = 10;
        const ROWS = ['A', 'B', 'C', 'D', 'E']; // 50 seats total

        // --- Initial Data Generation Functions ---

        function generateInitialSeatingMap() {
            const seatingMap = {};
            ROWS.forEach(row => {
                for (let i = 1; i <= SEATS_PER_ROW; i++) {
                    const seatId = `${row}-${i}`;
                    seatingMap[seatId] = { isReserved: false };
                }
            });
            return seatingMap;
        }

        function createShowtimes(count) {
            const showtimes = [];
            let date = new Date();
            date.setDate(date.getDate() + 1); // Start from tomorrow
            const baseShowtime = date.setHours(20, 0, 0, 0); // 20:00

            for (let i = 0; i < count; i++) {
                let showDate = new Date(baseShowtime);
                // Spread showtimes over subsequent days
                showDate.setDate(showDate.getDate() + i);

                showtimes.push({
                    id: `t${i + 1}`,
                    dateTime: showDate.toISOString(),
                    reservedSeats: [],
                    seatingMap: generateInitialSeatingMap() // Each showtime has its own map
                });
            }
            return showtimes;
        }

        // Initial play data with showtimes
        const initialPlays = [
            {
                title: "כוית ומופסון",
                description: "קומדיה מרגשת על שני חברים טובים שמנסים להסתגל לעולם המודרני, תוך התמודדות עם אתגרים מצחיקים ומרגשים. (30 מועדים)",
                image: "https://placehold.co/600x400/d49a75/fff?text=Kavit+and+Mofson",
                type: "קומדיה",
                price: 85,
                showtimes: createShowtimes(30) // User requested 30 slots
            },
            {
                title: "מרי השלג",
                description: "הצגה דרמטית על מערכת יחסים בין אם לבתה על רקע נופי החורף הארקטי. סיפור נוגע ללב על אהבה, הקרבה וגאולה. (5 מועדים)",
                image: "https://placehold.co/600x400/a77756/fff?text=Snow+Mary",
                type: "דרמה",
                price: 100,
                showtimes: createShowtimes(5)
            },
            {
                title: "בצליקו ותפוזיקו",
                description: "הצגת ילדים צבעונית ומלאת דמיון על שני חברים, בצל ותפוז, שיוצאים למסע למציאת המרכיב הסודי להכנת עוגה מיוחדת. (5 מועדים)",
                image: "https://placehold.co/600x400/98c1d9/fff?text=Btzaliko+and+Tapuziko",
                type: "ילדים",
                price: 50,
                showtimes: createShowtimes(5)
            },
            {
                title: "מלחי ופלפל",
                description: "הצגה מוזיקלית קלילה ומהנה על שני תבלינים, מלח ופלפל, שרוצים להוסיף טעם לחיים. (5 מועדים)",
                image: "https://placehold.co/600x400/5c6b73/fff?text=Malahi+and+Pilpel",
                type: "מוזיקלי",
                price: 90,
                showtimes: createShowtimes(5)
            }
        ];

        // --- Utility Functions ---
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('he-IL', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function showMessageModal(message) {
            document.getElementById('modal-text').textContent = message;
            messageModalEl.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function navigateTo(view) {
            homeView.classList.add('hidden');
            myOrdersView.classList.add('hidden');
            paymentView.classList.add('hidden');
            adminDashboardView.classList.add('hidden');
            recommendedPlaysSection.classList.add('hidden');

            // If not logged in and trying to access private views, force login modal
            if (!userId && (view === 'my-orders' || view === 'admin-dashboard')) {
                authModalEl.style.display = 'flex';
                return;
            }

            if (view === 'home') {
                homeView.classList.remove('hidden');
                if (userId && !isAdmin) {
                    // showRecommendations(); // Omitted for brevity, but should run here if logic exists
                }
            } else if (view === 'my-orders') {
                myOrdersView.classList.remove('hidden');
                listenForOrders(userId);
            } else if (view === 'payment') {
                paymentView.classList.remove('hidden');
            } else if (view === 'admin-dashboard') {
                if (isAdmin) {
                    adminDashboardView.classList.remove('hidden');
                    loadAdminData();
                } else {
                    showMessageModal("אין לך הרשאה לגשת לדף זה.");
                }
            }
        }

        // --- Firebase Initialization and Auth Fix ---

        window.onload = function() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    listenForPlays(); // <-- LOAD PUBLIC DATA IMMEDIATELY
                    initializeAuthAndListeners(); // <-- HANDLE AUTH STATE SEPARATELY
                    requestNotificationPermission();
                    setupRecurringNotifications();
                } else {
                    showMessageModal("שגיאת התחברות: הגדרות Firebase לא נמצאו.");
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessageModal("שגיאת התחברות: " + error.message);
            }
        };

        async function initializeAuthAndListeners() {
            // 1. Initial Sign-in Attempt
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Initial authentication successful with custom token.");
                } else {
                    console.warn("No initial auth token found. User must sign in manually.");
                    if (!auth.currentUser) {
                        authModalEl.style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error("Failed to perform initial authentication:", error);
            }

            // 2. Set up Auth State Listener (CRITICAL: Calls data loading ONLY when state changes)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAdmin = user.email === ADMIN_EMAIL;
                    userInfoEl.textContent = `שלום, ${user.email}`;
                    loggedInStateEl.classList.remove('hidden');
                    loggedOutStateEl.classList.add('hidden');
                    if (isAdmin) {
                        adminDashboardBtn.classList.remove('hidden');
                    } else {
                        adminDashboardBtn.classList.add('hidden');
                    }
                    console.log("User is signed in with ID:", userId);
                    // navigateTo('home') is implicitly called by the UI loading home first
                } else {
                    userId = null;
                    isAdmin = false;
                    loggedInStateEl.classList.add('hidden');
                    loggedOutStateEl.classList.remove('hidden');
                    adminDashboardBtn.classList.add('hidden');
                    console.log("User is signed out.");
                }
            });
        }


        // --- Notification Functions ---
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                    } else {
                        console.log('Notification permission denied.');
                    }
                });
            }
        }

        function showPushNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: body });
            }
        }

        function setupRecurringNotifications() {
            // Send a notification every minute for demo purposes
            setInterval(() => {
                if (Notification.permission === 'granted') {
                    showPushNotification('אל תחמיצו!', 'אנו מחכים לכם בתיאטרון כוית ומופסון! בדקו את המועדים החדשים.');
                }
            }, 60000);
        }

        // --- Plays and Data Functions ---

        function renderPlays(plays, container) {
            const searchQuery = searchInput.value.toLowerCase();
            const filterType = filterSelect.value;

            const filteredPlays = plays.filter(play => {
                const matchesSearch = play.title.toLowerCase().includes(searchQuery);
                const matchesFilter = filterType === 'all' || play.type === filterType;
                return matchesSearch && matchesFilter;
            });

            container.innerHTML = '';
            if (filteredPlays.length === 0) {
                container.innerHTML = `<p class="text-center col-span-full text-gray-500">לא נמצאו הצגות.</p>`;
            } else {
                filteredPlays.forEach(play => {
                    const card = document.createElement('div');
                    card.className = 'card bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1';
                    card.innerHTML = `
                        <img src="${play.image}" alt="${play.title}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=Image+Not+Found'">
                        <div class="p-6 flex flex-col items-start">
                            <h3 class="text-xl font-bold gradient-text mb-2">${play.title}</h3>
                            <p class="text-sm text-gray-600 mb-4">${play.description}</p>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full text-white gradient-background mb-4">${play.type}</span>
                            <span class="text-xl font-bold text-gray-800 self-end">${play.price} ₪</span>
                            <button onclick="openBookingModal('${play.id}', '${play.title}')" class="w-full mt-4 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white gradient-background hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                                בחר מועד והזמן
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        // Listen for real-time updates to the 'plays' collection
        async function listenForPlays() {
            const playsCollectionRef = collection(db, `artifacts/${appId}/public/data/plays`);

            try {
                // Add initial data if the collection is empty (using getDocs outside onSnapshot to check existence)
                const initialDocs = await getDocs(query(playsCollectionRef));
                if (initialDocs.empty) {
                    console.log("Collection is empty, adding initial data...");
                    for (const play of initialPlays) {
                        // Use a specific ID if necessary, but addDoc is fine for now
                        await addDoc(playsCollectionRef, { ...play, createdAt: serverTimestamp() });
                    }
                    console.log("Initial data added successfully.");
                }
            } catch (error) {
                 console.error("Error during initial play data check/insertion:", error);
                 // The onSnapshot will now try to load whatever is available or fail gracefully
            }


            // Set up real-time listener
            onSnapshot(query(playsCollectionRef), (snapshot) => {
                allPlays = [];
                snapshot.forEach(doc => {
                    allPlays.push({ id: doc.id, ...doc.data() });
                });
                allPlays.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                // Render immediately when data arrives
                renderPlays(allPlays, eventsContainer); 
            }, (error) => {
                console.error("Error listening to plays:", error);
                eventsContainer.innerHTML = `<p class="text-center col-span-full text-red-500">שגיאה בטעינת ההצגות. אנא בדוק את הרשאות Firebase.</p>`;
            });
        }

        // Show personalized recommendations (unchanged logic)
        async function showRecommendations() {
            // ... (Recommendation logic remains the same, omitted for brevity)
        }

        // --- Booking Modal Logic (Showtime and Seat Selection) ---

        function resetBookingState() {
            currentBooking = { playId: null, playTitle: null, showtimeId: null, showtimeText: null, selectedSeats: [] };
        }

        function openBookingModal(playId, playTitle) {
            if (!userId) {
                showMessageModal("יש להתחבר כדי לבחור מועד ולהזמין כרטיסים.");
                return;
            }

            resetBookingState();
            currentBooking.playId = playId;
            currentBooking.playTitle = playTitle;

            const play = allPlays.find(p => p.id === playId);
            if (!play || !play.showtimes || play.showtimes.length === 0) {
                showMessageModal("לא נמצאו מועדים זמינים להצגה זו.");
                return;
            }

            modalPlayTitleEl.textContent = `הזמנת כרטיסים ל- ${playTitle}`;
            renderShowtimes(play.showtimes);

            // Show Stage 1
            showtimeSelectionStage.classList.remove('hidden');
            seatSelectionStage.classList.add('hidden');
            bookingModalEl.style.display = 'flex';
        }

        function renderShowtimes(showtimes) {
            showtimesContainer.innerHTML = '';
            // Filter out showtimes in the past (optional, but good practice)
            const futureShowtimes = showtimes.filter(st => new Date(st.dateTime) > new Date());
            
            if (futureShowtimes.length === 0) {
                showtimesContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">לא נמצאו מועדים עתידיים זמינים.</p>`;
                return;
            }

            futureShowtimes.forEach(showtime => {
                const dateTimeText = formatDateTime(showtime.dateTime);
                const totalSeats = ROWS.length * SEATS_PER_ROW;
                const reservedCount = showtime.reservedSeats ? showtime.reservedSeats.length : 0;
                const available = totalSeats - reservedCount;
                const button = document.createElement('button');

                button.className = `showtime-button w-full text-right p-3 rounded-lg shadow-md ${available > 0 ? 'bg-white hover:bg-gray-100 border border-gray-200' : 'bg-red-200 text-gray-500 cursor-not-allowed'}`;
                button.innerHTML = `
                    <p class="font-bold text-gray-800">${dateTimeText}</p>
                    <p class="text-sm text-gray-600">${available} מושבים פנויים מתוך ${totalSeats}</p>
                `;

                if (available > 0) {
                    button.onclick = () => selectShowtime(showtime.id, dateTimeText);
                }
                showtimesContainer.appendChild(button);
            });
        }

        function selectShowtime(showtimeId, showtimeText) {
            currentBooking.showtimeId = showtimeId;
            currentBooking.showtimeText = showtimeText;
            currentBooking.selectedSeats = []; // Reset selected seats when changing showtime

            selectedShowtimeDisplay.textContent = showtimeText;
            renderSeatSelectionStage();

            // Transition to Stage 2
            showtimeSelectionStage.classList.add('hidden');
            seatSelectionStage.classList.remove('hidden');
        }

        backToShowtimesBtn.addEventListener('click', () => {
            showtimeSelectionStage.classList.remove('hidden');
            seatSelectionStage.classList.add('hidden');
        });

        function renderSeatSelectionStage() {
            const play = allPlays.find(p => p.id === currentBooking.playId);
            const showtime = play.showtimes.find(st => st.id === currentBooking.showtimeId);
            if (!showtime) return;

            const seatingData = showtime.seatingMap;
            const seatRowsContainer = document.getElementById('seat-rows');
            seatRowsContainer.innerHTML = '';

            const selectedSeatsCountEl = document.getElementById('selected-seats-count');
            const selectedSeatsPriceEl = document.getElementById('selected-seats-price');

            selectedSeatsCountEl.textContent = currentBooking.selectedSeats.length;
            const totalPrice = (currentBooking.selectedSeats.length * play.price).toFixed(2);
            selectedSeatsPriceEl.textContent = totalPrice;

            ROWS.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex justify-center flex-wrap mb-2';

                for (let i = 1; i <= SEATS_PER_ROW; i++) {
                    const seatId = `${row}-${i}`;
                    const seatInfo = seatingData[seatId];
                    const seatEl = document.createElement('div');

                    let seatClass = 'seat';
                    const isSelected = currentBooking.selectedSeats.includes(seatId);

                    if (seatInfo?.isReserved) {
                        seatClass += ' reserved';
                    } else if (isSelected) {
                        seatClass += ' selected';
                    } else {
                        seatClass += ' available';
                    }

                    seatEl.className = seatClass;
                    seatEl.textContent = i;
                    seatEl.dataset.seatId = seatId;

                    if (!seatInfo?.isReserved) {
                        seatEl.addEventListener('click', () => toggleSeatSelection(seatId));
                    }
                    rowEl.appendChild(seatEl);
                }
                seatRowsContainer.appendChild(rowEl);
            });
        }

        function toggleSeatSelection(seatId) {
            const index = currentBooking.selectedSeats.indexOf(seatId);
            if (index > -1) {
                // Deselect
                currentBooking.selectedSeats.splice(index, 1);
            } else {
                // Select
                currentBooking.selectedSeats.push(seatId);
            }
            // Sort for consistent display/storage
            currentBooking.selectedSeats.sort();
            renderSeatSelectionStage();
        }

        // Handle payment process
        proceedToPaymentBtn.addEventListener('click', () => {
            if (currentBooking.selectedSeats.length === 0) {
                showMessageModal("אנא בחר מושבים לפני התשלום.");
                return;
            }

            closeModal('booking-modal');
            navigateTo('payment');

            const play = allPlays.find(p => p.id === currentBooking.playId);
            const totalPrice = currentBooking.selectedSeats.length * (play?.price || 0);

            paymentPlayTitleEl.textContent = currentBooking.playTitle;
            paymentShowtimeTextEl.textContent = currentBooking.showtimeText;
            paymentTotalPriceEl.textContent = totalPrice.toFixed(2);
        });


        // Handle form submission for payment
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedSeats = currentBooking.selectedSeats;
            if (selectedSeats.length === 0) {
                paymentMessageEl.textContent = 'אנא בחר מושבים לפני התשלום.';
                return;
            }

            const play = allPlays.find(p => p.id === currentBooking.playId);
            const showtime = play.showtimes.find(st => st.id === currentBooking.showtimeId);
            const totalPrice = selectedSeats.length * (play?.price || 0);

            try {
                const playRef = doc(db, `artifacts/${appId}/public/data/plays`, currentBooking.playId);

                // Update the seating map within the specific showtime
                const updatedShowtimes = play.showtimes.map(st => {
                    if (st.id === currentBooking.showtimeId) {
                        const updatedSeatingMap = JSON.parse(JSON.stringify(st.seatingMap));
                        selectedSeats.forEach(seatId => {
                            // Ensure seat exists before setting isReserved
                            if (updatedSeatingMap[seatId]) {
                                updatedSeatingMap[seatId].isReserved = true;
                            }
                        });
                        // Filter out nulls/undefineds just in case, though they shouldn't exist here
                        const currentReserved = st.reservedSeats || [];
                        const newReservedSeats = [...currentReserved, ...selectedSeats].filter(s => s);
                        
                        return {
                            ...st,
                            reservedSeats: newReservedSeats,
                            seatingMap: updatedSeatingMap
                        };
                    }
                    return st;
                });

                // 1. Update the play document with the new showtimes array
                await updateDoc(playRef, { showtimes: updatedShowtimes });

                // 2. Add booking to Firestore
                const bookingsCollectionRef = collection(db, `artifacts/${appId}/public/data/bookings`);
                const newBookingDocRef = await addDoc(bookingsCollectionRef, {
                    playTitle: currentBooking.playTitle,
                    showtimeId: currentBooking.showtimeId,
                    showtimeText: currentBooking.showtimeText,
                    seats: selectedSeats,
                    totalPrice: totalPrice,
                    bookingTime: serverTimestamp(),
                    userId: userId, // CRITICAL: This field MUST match request.auth.uid
                });

                // 3. Show confirmation modal
                document.getElementById('conf-play-title').textContent = currentBooking.playTitle;
                document.getElementById('conf-showtime').textContent = currentBooking.showtimeText;
                document.getElementById('conf-tickets').textContent = selectedSeats.length;
                document.getElementById('conf-seats').textContent = selectedSeats.join(', ');
                document.getElementById('conf-booking-id').textContent = newBookingDocRef.id;
                document.getElementById('conf-name').textContent = auth.currentUser.displayName || auth.currentUser.email;
                document.getElementById('conf-email').textContent = auth.currentUser.email;

                navigateTo('home');
                confirmationModalEl.style.display = 'flex';
                paymentForm.reset();
                resetBookingState();

                // 4. Show push notification
                showPushNotification('ההזמנה אושרה!', `הזמנתך ל'${currentBooking.playTitle}' (${currentBooking.showtimeText}) אושרה. המושבים שלך: ${selectedSeats.join(', ')}.`);

            } catch (error) {
                console.error("Error during booking process:", error);
                paymentMessageEl.textContent = `שגיאה בתשלום: ${error.message}`;
            }
        });

        // Listen for real-time updates to the 'bookings' collection for the current user (Unchanged, uses new fields)
        function listenForOrders(currentUserId) {
            const bookingsCollectionRef = collection(db, `artifacts/${appId}/public/data/bookings`);
            const q = query(bookingsCollectionRef, where("userId", "==", currentUserId));

            onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                orders.sort((a, b) => (b.bookingTime?.seconds || 0) - (a.bookingTime?.seconds || 0));
                renderOrders(orders);
            }, (error) => {
                console.error("Error listening to orders:", error);
                ordersContainer.innerHTML = `<p class="text-center text-red-500">שגיאה בטעינת ההזמנות: ${error.message}. ודא שאתה מחובר ויש לך הרשאות.</p>`;
            });
        }

        // Render the list of orders dynamically from Firestore (Updated to include showtimeText)
        function renderOrders(orders) {
            ordersContainer.innerHTML = '';
            if (orders.length === 0) {
                ordersContainer.innerHTML = `<p class="text-center text-gray-500">אין לך הזמנות כרגע.</p>`;
            } else {
                orders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = 'bg-white p-6 rounded-xl shadow-md';
                    const seats = Array.isArray(order.seats) ? order.seats.join(', ') : 'לא נבחרו מושבים';
                    orderCard.innerHTML = `
                        <h3 class="text-lg font-bold gradient-text mb-2">${order.playTitle}</h3>
                        <p class="text-sm text-gray-600"><strong>מועד:</strong> ${order.showtimeText || 'לא צוין'}</p>
                        <p class="text-sm text-gray-600"><strong>מושבים:</strong> ${seats}</p>
                        <p class="text-sm text-gray-600"><strong>סה"כ לתשלום:</strong> ${order.totalPrice} ₪</p>
                        <p class="text-sm text-gray-600"><strong>תאריך הזמנה:</strong> ${new Date(order.bookingTime.seconds * 1000).toLocaleDateString("he-IL")}</p>
                        <p class="text-xs text-gray-400 mt-2"><strong>מספר הזמנה:</strong> ${order.id}</p>
                    `;
                    ordersContainer.appendChild(orderCard);
                });
            }
        }

        // --- Admin Dashboard Functions (Updated for Showtime Management) ---

        // Load Admin Data (unchanged)
        async function loadAdminData() {
            if (!isAdmin) return;
            // ... (Sales report logic remains the same, omitted for brevity)

            // For now, only load and render admin plays list
            // NOTE: Admin play list rendering needs to be implemented or remains omitted
        }

        // Add event listener for adding showtime in admin modal
        document.getElementById('add-showtime-btn').addEventListener('click', () => {
            const newShowtime = {
                id: crypto.randomUUID(),
                dateTime: new Date().toISOString().substring(0, 16), // Default to current time for input field
                reservedSeats: [],
                seatingMap: generateInitialSeatingMap()
            };
            playInEdit.showtimes.push(newShowtime);
            renderShowtimeAdminControls(playInEdit.showtimes);
        });

        function renderShowtimeAdminControls(showtimes) {
            const container = document.getElementById('showtimes-admin-container');
            container.innerHTML = '';

            if (!showtimes || showtimes.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">אין מועדים מוגדרים להצגה זו.</p>`;
                return;
            }

            showtimes.forEach((st, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 space-x-reverse text-sm';
                div.innerHTML = `
                    <input type="datetime-local" value="${st.dateTime.substring(0, 16)}" 
                           onchange="updateShowtimeDateTime('${st.id}', this.value)" 
                           class="flex-1 p-1 border rounded-md">
                    <span class="text-xs text-gray-500 w-16">(${st.reservedSeats.length} נמכרו)</span>
                    <button type="button" onclick="removeShowtime('${st.id}')" class="text-red-500 hover:text-red-700">
                        &times;
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function updateShowtimeDateTime(id, value) {
            const showtime = playInEdit.showtimes.find(st => st.id === id);
            if (showtime) {
                // Ensure value is ISO string for internal storage
                showtime.dateTime = new Date(value).toISOString();
            }
        }

        function removeShowtime(id) {
            playInEdit.showtimes = playInEdit.showtimes.filter(st => st.id !== id);
            renderShowtimeAdminControls(playInEdit.showtimes);
        }

        function openPlayFormModal(playId) {
            playForm.reset();
            playFormMessageEl.textContent = '';
            if (playId) {
                const play = allPlays.find(p => p.id === playId);
                if (play) {
                    playInEdit = JSON.parse(JSON.stringify(play)); // Deep copy for editing
                    playFormTitle.textContent = "ערוך הצגה";
                    playTitleInput.value = playInEdit.title;
                    playDescriptionInput.value = playInEdit.description;
                    playTypeInput.value = playInEdit.type;
                    playPriceInput.value = playInEdit.price;
                    playImageInput.value = playInEdit.image;
                    renderShowtimeAdminControls(playInEdit.showtimes);
                }
            } else {
                playFormTitle.textContent = "הוסף הצגה חדשה";
                playInEdit = { showtimes: createShowtimes(5) }; // Default showtimes for new play
                renderShowtimeAdminControls(playInEdit.showtimes);
            }
            playFormModal.style.display = 'flex';
        }

        playForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const playData = {
                title: playTitleInput.value,
                description: playDescriptionInput.value,
                type: playTypeInput.value,
                price: Number(playPriceInput.value),
                image: playImageInput.value,
                showtimes: playInEdit.showtimes // Use the edited showtimes
            };

            try {
                if (playInEdit.id) {
                    const playRef = doc(db, `artifacts/${appId}/public/data/plays`, playInEdit.id);
                    await updateDoc(playRef, playData);
                    showMessageModal("הצגה עודכנה בהצלחה!");
                } else {
                    const playsCollectionRef = collection(db, `artifacts/${appId}/public/data/plays`);
                    await addDoc(playsCollectionRef, {
                        ...playData,
                        createdAt: serverTimestamp(),
                    });
                    showMessageModal("הצגה נוספה בהצלחה!");
                }
                closeModal('play-form-modal');
            } catch (error) {
                console.error("Error saving play:", error);
                playFormMessageEl.textContent = "שגיאה בשמירת ההצגה: " + error.message;
            }
        });

        // Delete play (Admin functionality - placeholder)
        async function deletePlay(playId) {
            if (!isAdmin) {
                showMessageModal("אין לך הרשאה למחוק הצגות.");
                return;
            }
            if (window.confirm("האם אתה בטוח שברצונך למחוק הצגה זו?")) {
                try {
                    const playRef = doc(db, `artifacts/${appId}/public/data/plays`, playId);
                    await deleteDoc(playRef);
                    showMessageModal("הצגה נמחקה בהצלחה.");
                } catch (error) {
                    console.error("Error deleting play:", error);
                    showMessageModal("שגיאה במחיקת ההצגה: " + error.message);
                }
            }
        }

        // --- Auth Functions (Revised) ---
        loginButton.addEventListener('click', () => {
            authMode = 'login';
            document.getElementById('auth-modal-title').textContent = 'התחברות';
            document.getElementById('auth-submit-button').textContent = 'התחבר';
            document.getElementById('toggle-auth-mode').textContent = 'אין לך חשבון? הירשם';
            authModalEl.style.display = 'flex';
            document.getElementById('auth-message').textContent = '';
        });

        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                await signOut(auth);
                navigateTo('home');
                showMessageModal("התנתקת בהצלחה.");
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageModal("שגיאה בהתנתקות: " + error.message);
            }
        });

        document.getElementById('toggle-auth-mode').addEventListener('click', () => {
            authMode = authMode === 'login' ? 'signup' : 'login';
            document.getElementById('auth-modal-title').textContent = authMode === 'login' ? 'התחברות' : 'הרשמה';
            document.getElementById('auth-submit-button').textContent = authMode === 'login' ? 'התחבר' : 'הירשם';
            document.getElementById('toggle-auth-mode').textContent = authMode === 'login' ? 'אין לך חשבון? הירשם' : 'כבר יש לך חשבון? התחבר';
            document.getElementById('auth-message').textContent = '';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = document.getElementById('auth-password').value;
            document.getElementById('auth-message').textContent = '';
            try {
                if (authMode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessageModal("נרשמת בהצלחה! התחברות אוטומטית...");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessageModal("התחברת בהצלחה!");
                }
                closeModal('auth-modal');
                navigateTo('home');
            } catch (error) {
                console.error("Auth error:", error);
                let message = "שגיאה בהתחברות/הרשמה.";
                if (error.code === 'auth/email-already-in-use') {
                    message = 'כתובת האימייל כבר בשימוש.';
                } else if (error.code === 'auth/invalid-email' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    message = 'שם משתמש או סיסמה שגויים.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'הסיסמה חלשה מדי. נסה סיסמה עם לפחות 6 תווים.';
                } else if (error.code === 'auth/operation-not-allowed') {
                     message = 'הרשמה/התחברות באמצעות אימייל וסיסמה אינה מופעלת בפרויקט Firebase.';
                }
                document.getElementById('auth-message').textContent = message;
            }
        });

        // Initial listeners
        searchInput.addEventListener('input', () => renderPlays(allPlays, eventsContainer));
        filterSelect.addEventListener('change', () => renderPlays(allPlays, eventsContainer));
        document.getElementById('add-play-btn').addEventListener('click', () => openPlayFormModal(null));

    </script>
</body>
</html>
