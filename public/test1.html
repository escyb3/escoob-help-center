<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 驻住</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

<div id="app" v-cloak>
    <!-- Quiz Interface -->
    <div v-if="view === 'quiz'" class="py-10 px-4">
        <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-3xl overflow-hidden border border-slate-200">
            <div class="bg-blue-800 text-white p-8 text-center relative">
                <h1 class="text-4xl font-black mb-2"> 转 驻住</h1>
                <p class="text-blue-100 italic">"砖 注转 专拽 注 住驻专 砖转 专砖  拽"</p>
                
                <div class="mt-6 pt-4 border-t border-blue-700/50 flex flex-col items-center">
                    <div class="flex gap-2">
                        <input id="passInput" type="password" placeholder="住住转 专" class="text-black text-xs p-1 rounded w-24 outline-none">
                        <button onclick="handleTeacherAccess()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded">住转 专</button>
                    </div>
                </div>
            </div>

            <form id="quizForm" onsubmit="handleFormSubmit(event)" class="p-8 space-y-12">
                <section class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <label class="block text-lg font-bold mb-2">砖 : <span class="text-red-500">*</span></label>
                    <input required name="studentName" type="text" class="w-full md:w-1/2 p-3 rounded-xl border border-blue-200 outline-none focus:ring-4 focus:ring-blue-100" placeholder="住 转 砖...">
                </section>

                <section>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-blue-800 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold"></span>
                        <h2 class="text-2xl font-bold text-slate-800">拽 ':  驻住 (50 拽转)</h2>
                    </div>
                    
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-bold text-blue-700 mb-4 underline">砖转 专拽转 (7 砖转 )</h3>
                            <div id="americanQuestions" class="space-y-6"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-blue-700 mb-4 underline">砖转 驻转转 (6 砖转 )</h3>
                            <div id="openQuestionsA" class="space-y-6"></div>
                        </div>
                    </div>
                </section>

                <section class="border-t pt-12">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold"></span>
                        <h2 class="text-2xl font-bold text-slate-800">拽 ': 专转 驻专拽 (50 拽转)</h2>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-10 text-center">
                        <button type="button" onclick="selectChapter('A')" id="btnA" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">驻专拽 '</h4>
                            <p class="text-sm"> </p>
                        </button>
                        <button type="button" onclick="selectChapter('B')" id="btnB" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">驻专拽 '</h4>
                            <p class="text-sm"> 砖专</p>
                        </button>
                    </div>
                    <div id="chapterSection" class="hidden bg-green-50/30 p-6 rounded-3xl border border-green-100 space-y-6 fade-in"></div>
                </section>

                <button type="submit" id="submitBtn" class="w-full py-6 rounded-full text-2xl font-black text-white shadow-2xl transition transform hover:scale-[1.02] active:scale-95 bg-blue-700 hover:bg-blue-800">
                    砖  住驻 拽
                </button>
            </form>
        </div>
    </div>

    <!-- Submitted View -->
    <div v-if="view === 'submitted'" class="min-h-screen bg-slate-50 flex items-center justify-center p-6 fade-in">
        <div id="statusCard" class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center max-w-2xl border-t-8 border-green-500 w-full">
            <div class="text-7xl mb-6"></div>
            <h2 class="text-3xl font-bold mb-4"> 砖 爪!</h2>
            <div id="submissionContent"></div>
            <button onclick="location.reload()" class="mt-8 text-blue-500 underline hover:text-blue-700">专 祝 转</button>
        </div>
    </div>

    <!-- Teacher View -->
    <div v-if="view === 'teacher'" class="min-h-screen bg-slate-100 p-4 md:p-8 fade-in">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800"> 拽转 </h1>
                <button onclick="setView('quiz')" class="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700">爪</button>
            </div>

            <div id="submissionsList" class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                <table class="w-full text-right border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4 border-b">砖 转</th>
                            <th class="p-4 border-b"> 砖</th>
                            <th class="p-4 border-b">驻专拽</th>
                            <th class="p-4 border-b">住住</th>
                            <th class="p-4 border-b">驻注转</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody"></tbody>
                </table>
            </div>

            <div id="gradingPanel" class="hidden mt-8 bg-white rounded-2xl shadow-2xl p-6 md:p-8 border border-blue-200 fade-in">
                <!-- Content generated via JS -->
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyC-9NehHTUoE_vPzsiz4Y0LWgNC1-6W3C0",
        authDomain: "testnum1-kawitvemufason.firebaseapp.com",
        projectId: "testnum1-kawitvemufason",
        storageBucket: "testnum1-kawitvemufason.firebasestorage.app",
        messagingSenderId: "85481039106",
        appId: "1:85481039106:web:d82756601be5d3bc4e8e1b",
        measurementId: "G-ENDQBP3G0P"
    };

    const TEACHER_PASSWORD = "1234";
    const appId = "testnum1-kawitvemufason";

    // --- State ---
    let view = 'quiz';
    let selectedChapter = null;
    let submissions = [];
    let currentUser = null;
    let inspectingId = null;
    let unsubscribeSubmissions = null;

    // --- Initialization ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // RULE 3: Strict Auth Logic
    const initApp = async () => {
        try {
            // Sign in and wait for completion
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            console.log("Authenticated as:", currentUser.uid);
            
            // Start listening ONLY after auth is confirmed
            setupRealtimeSubmissions();
        } catch (err) {
            console.error("Auth initialization failed:", err);
            // Retry after 2 seconds if failed
            setTimeout(initApp, 2000);
        }
    };

    // Use onAuthStateChanged as a secondary safety net
    auth.onAuthStateChanged(user => {
        if (user && !currentUser) {
            currentUser = user;
            setupRealtimeSubmissions();
        }
    });

    function setView(newView) {
        view = newView;
        document.querySelectorAll('#app > div').forEach(div => div.style.display = 'none');
        const activeView = document.querySelector(`[v-if="view === '${newView}'"]`);
        if (activeView) activeView.style.display = 'block';
        if (newView === 'submitted') renderSubmissionStatus();
        if (newView === 'teacher') renderSubmissionsTable();
    }

    function setupRealtimeSubmissions() {
        if (!currentUser) return;

        if (unsubscribeSubmissions) unsubscribeSubmissions();

        // RULE 1: Correct collection path
        const submissionsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions');
        
        unsubscribeSubmissions = submissionsRef.onSnapshot(snapshot => {
            submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // RULE 2: Sort in memory
            submissions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            if (view === 'teacher') renderSubmissionsTable();
            if (view === 'submitted') renderSubmissionStatus();
        }, error => {
            console.error("Firestore Permission/Snapshot error:", error);
            // If permission denied, wait and re-init auth
            if (error.code === 'permission-denied') {
                console.log("Retrying auth due to permission error...");
                setTimeout(initApp, 1000);
            }
        });
    }

    // --- Content Rendering ---
    const americanQs = [
        {id: 'q1', q: ' 驻 转 拽爪 砖 注 砖 专砖转 专?', opts: ['.  注', '. 拽爪转 砖', '. ', '. 专驻']},
        {id: 'q2', q: ' 驻  专 砖注 转转 注 ?', opts: ['. 驻住', '. 驻', '.  转驻', '. 转拽 ']},
        {id: 'q3', q: '爪 注  砖 专驻 ?', opts: ['. 转转', '. 注 转专', '. 转 转', '. 驻住 爪']},
        {id: 'q4', q: ' 转 转 砖 注 砖 专转?', opts: ['.  ', '. ', '. 砖专', '.  ']},
        {id: 'q5', q: '  住 砖 驻住 驻 注 砖?', opts: ['. 拽', '. 转 ', '. 专驻 砖', '. 住专 驻砖']},
        {id: 'q6', q: '  驻住 注 爪爪?', opts: ['. 转', '. 爪 ', '. 专注 住 ', '. 专驻']},
        {id: 'q7', q: ' 拽专  转  转驻?', opts: ['. ', '. 爪', '. 注专 -5 拽 ', '. 转']}
    ];

    const openQs = [
        "转专 转 转 砖 注 砖.   注专?",
        "住专 转 专转 住驻专 砖  .",
        "  '住' 砖驻注 转拽驻转  转驻?",
        " 砖注转 砖驻 '砖  拽砖 拽抓 '?",
        "爪 砖转 住 砖 驻住 专 ?",
        "   专 '驻住' 专 '驻住'?"
    ];

    function renderQuiz() {
        const amContainer = document.getElementById('americanQuestions');
        if (!amContainer) return;
        amContainer.innerHTML = americanQs.map((q, i) => `
            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                <div class="grid md:grid-cols-2 gap-2">
                    ${q.opts.map(o => `
                        <label class="flex items-center gap-2 p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50">
                            <input type="radio" name="${q.id}" value="${o[0]}" class="w-4 h-4">
                            <span class="text-sm">${o}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');

        const opContainer = document.getElementById('openQuestionsA');
        if (!opContainer) return;
        opContainer.innerHTML = openQs.map((q, i) => `
            <div class="space-y-2">
                <p class="font-bold">${i+8}. ${q}</p>
                <textarea name="oa${i}" class="w-full p-4 border rounded-xl min-h-[100px] focus:ring-2 focus:ring-blue-100 outline-none"></textarea>
            </div>
        `).join('');
    }

    function selectChapter(c) {
        selectedChapter = c;
        document.getElementById('btnA').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'A' ? 'border-green-600 bg-green-50' : 'border-slate-100'}`;
        document.getElementById('btnB').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'B' ? 'border-green-600 bg-green-50' : 'border-slate-100'}`;
        
        const section = document.getElementById('chapterSection');
        section.classList.remove('hidden');
        section.innerHTML = `
            <p class="font-bold text-green-800 italic text-center">注 注 砖转 驻专拽 砖专转 (${c === 'A' ? '' : ''}):</p>
            ${[1,2,3].map(i => `
                <div class="space-y-2">
                    <p class="font-bold">砖 驻转 ${i} 驻专拽 ${c}:</p>
                    <textarea name="p${c}_q${i}" class="w-full p-4 border rounded-xl min-h-[100px] outline-none bg-white"></textarea>
                </div>
            `).join('')}
        `;
    }

    // --- Actions ---
    function handleTeacherAccess() {
        const pass = document.getElementById('passInput').value;
        if (pass === TEACHER_PASSWORD) {
            setView('teacher');
        } else {
            alert("住住 砖!");
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        if (!currentUser) {
            alert("注专转 注 转专转 砖专转.  转 专注 住 砖.");
            initApp();
            return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        if (!data.studentName?.trim()) return alert("砖  砖 转");
        if (!selectedChapter) return alert("砖 专 驻专拽 拽 '");

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "砖 ...";

        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').add({
                studentName: data.studentName,
                timestamp: Date.now(),
                responses: data,
                chapter: selectedChapter,
                userId: currentUser.uid,
                finalGrade: null,
                teacherFeedback: null
            });
            setView('submitted');
        } catch (err) {
            alert("砖 砖专: " + err.message);
            btn.disabled = false;
            btn.innerText = "砖  住驻 拽";
        }
    }

    function renderSubmissionStatus() {
        const container = document.getElementById('submissionContent');
        if (!container) return;

        const mySub = submissions.find(s => s.userId === (currentUser ? currentUser.uid : null));
        
        if (!mySub) {
            container.innerHTML = `<p class="text-xl text-slate-600 mb-6 font-medium"> 砖 注专转.</p>`;
            return;
        }

        if (mySub.finalGrade) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200">
                        <p class="text-blue-800 font-bold text-lg"> 拽!</p>
                        <p class="text-5xl font-black text-blue-900 mt-2">爪: ${mySub.finalGrade}</p>
                    </div>
                    ${mySub.teacherFeedback ? `
                        <div class="bg-amber-50 p-6 rounded-2xl border border-amber-200 text-right">
                            <p class="font-bold text-amber-900 mb-2">注专转 专:</p>
                            <p class="text-slate-700 whitespace-pre-wrap">${mySub.teacherFeedback}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="p-6 bg-slate-100 rounded-2xl border border-dashed border-slate-300">
                    <p class="text-slate-500 italic">转砖转 砖 砖专. 专 拽 转  注转.</p>
                </div>
            `;
        }
    }

    function renderSubmissionsTable() {
        const body = document.getElementById('submissionsTableBody');
        if (!body) return;
        
        if (submissions.length === 0) {
            body.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400">专 砖 </td></tr>`;
            return;
        }

        body.innerHTML = submissions.map(s => `
            <tr class="border-b hover:bg-slate-50 transition">
                <td class="p-4 font-bold">${s.studentName}</td>
                <td class="p-4 text-sm text-slate-500">${new Date(s.timestamp).toLocaleString('he-IL')}</td>
                <td class="p-4 text-center">${s.chapter === 'A' ? '' : ''}</td>
                <td class="p-4">
                    ${s.finalGrade ? 
                      `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">拽 (${s.finalGrade})</span>` : 
                      `<span class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold">转</span>`}
                </td>
                <td class="p-4">
                    <button onclick="inspectSubmission('${s.id}')" class="bg-blue-600 text-white px-4 py-1 rounded-md text-sm hover:bg-blue-700">拽</button>
                </td>
            </tr>
        `).join('');
    }

    function inspectSubmission(id) {
        const sub = submissions.find(s => s.id === id);
        if (!sub) return;
        inspectingId = id;
        document.getElementById('submissionsList').classList.add('hidden');
        const panel = document.getElementById('gradingPanel');
        panel.classList.remove('hidden');

        const responsesHtml = Object.entries(sub.responses).map(([k, v]) => `
            <div class="border-b pb-4">
                <p class="text-xs font-bold text-blue-500 uppercase">${k}</p>
                <p class="text-slate-800 bg-slate-50 p-3 rounded-lg mt-1 border border-slate-100">${v || '---'}</p>
            </div>
        `).join('');

        panel.innerHTML = `
            <div class="flex justify-between items-start border-b pb-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-blue-900">拽: ${sub.studentName}</h2>
                </div>
                <button onclick="closeGrading()" class="text-slate-400 hover:text-slate-600 font-bold">住专 X</button>
            </div>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="md:col-span-2 space-y-6 max-h-[60vh] overflow-y-auto pl-4">${responsesHtml}</div>
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 space-y-4 h-fit sticky top-4">
                    <h3 class="font-bold text-xl text-slate-800">注专转 爪</h3>
                    <textarea id="tFeedback" class="w-full p-3 border rounded-xl h-40 outline-none text-sm" placeholder="砖    ...">${sub.teacherFeedback || ''}</textarea>
                    <input id="tGrade" type="number" class="w-full p-3 border rounded-xl font-bold text-xl text-blue-700 outline-none" placeholder="爪" value="${sub.finalGrade || ''}">
                    <button onclick="saveGrading()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 shadow-lg">砖专 砖</button>
                </div>
            </div>
        `;
    }

    function closeGrading() {
        document.getElementById('gradingPanel').classList.add('hidden');
        document.getElementById('submissionsList').classList.remove('hidden');
    }

    async function saveGrading() {
        if (!currentUser) return alert("专 .  专注 转 祝.");
        const feedback = document.getElementById('tFeedback').value;
        const grade = document.getElementById('tGrade').value;
        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').doc(inspectingId).update({
                finalGrade: grade,
                teacherFeedback: feedback,
                gradedAt: Date.now()
            });
            alert("爪 砖专 爪!");
            closeGrading();
        } catch (err) {
            alert("砖 注: " + err.message);
        }
    }

    // Main Run
    window.onload = () => {
        renderQuiz();
        setView('quiz');
        initApp(); // Start the strict auth-first chain
    };
</script>

</body>
</html>
