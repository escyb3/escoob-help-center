<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 转 驻住</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

<div id="app">
    <!-- Quiz Interface -->
    <div id="view-quiz" class="view-section py-10 px-4 active">
        <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-3xl overflow-hidden border border-slate-200">
            <div class="bg-blue-800 text-white p-8 text-center relative">
                <div class="text-sm font-bold mb-2 opacity-80">"</div>
                <h1 class="text-4xl font-black mb-2"> 转 驻住</h1>
                <p class="text-blue-100 italic">"转 拽专, 砖 注转 专拽 注 住驻专 砖转 专砖  拽!"</p>
                
                <div class="mt-6 pt-4 border-t border-blue-700/50 flex flex-col items-center">
                    <div class="flex gap-2">
                        <input id="passInput" type="password" placeholder="住住转 专" class="text-black text-xs p-1 rounded w-24 outline-none">
                        <button onclick="handleTeacherAccess()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded">住转 专</button>
                    </div>
                </div>
            </div>

            <form id="quizForm" onsubmit="handleFormSubmit(event)" class="p-8 space-y-12">
                <section class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <label class="block text-lg font-bold mb-2">砖 : <span class="text-red-500">*</span></label>
                    <input required name="studentName" type="text" class="w-full md:w-1/2 p-3 rounded-xl border border-blue-200 outline-none focus:ring-4 focus:ring-blue-100" placeholder="住 转 砖...">
                </section>

                <!-- Part A -->
                <section>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-blue-800 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold"></span>
                        <h2 class="text-2xl font-bold text-slate-800">拽 ':  驻住 (50 拽转)</h2>
                    </div>
                    
                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-blue-700 underline">砖转 专拽转 (注 注 7 )</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">20 拽转</span>
                            </div>
                            <div id="americanQuestions" class="space-y-6"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-blue-700 underline">砖转 驻转转 (注 注 6 )</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">30 拽转</span>
                            </div>
                            <div id="openQuestionsA" class="space-y-6"></div>
                        </div>
                    </div>
                </section>

                <!-- Part B -->
                <section class="border-t pt-12">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold"></span>
                        <h2 class="text-2xl font-bold text-slate-800">拽 ': 爪爪  转拽 ' (50 拽转)</h2>
                    </div>
                    <p class="mb-6 text-slate-600 font-medium italic">专  驻专拽  注 注  砖转 砖:</p>
                    
                    <div class="flex flex-col md:flex-row gap-4 mb-10 text-center">
                        <button type="button" onclick="selectChapter('A')" id="btnA" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">驻专拽 '</h4>
                            <p class="text-sm">砖驻转 ' </p>
                        </button>
                        <button type="button" onclick="selectChapter('B')" id="btnB" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">驻专拽 '</h4>
                            <p class="text-sm">砖驻转 ' 砖专</p>
                        </button>
                    </div>
                    <div id="chapterSection" class="hidden bg-green-50/30 p-6 rounded-3xl border border-green-100 space-y-6 fade-in"></div>
                </section>

                <button type="submit" id="submitBtn" class="w-full py-6 rounded-full text-2xl font-black text-white shadow-2xl transition transform hover:scale-[1.02] active:scale-95 bg-blue-700 hover:bg-blue-800">
                    砖  住驻 拽
                </button>
            </form>
        </div>
    </div>

    <!-- Other Views (Submitted, Teacher) same as before -->
    <div id="view-submitted" class="view-section min-h-screen bg-slate-50 flex items-center justify-center p-6 fade-in">
        <div id="statusCard" class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center max-w-2xl border-t-8 border-green-500 w-full">
            <div class="text-7xl mb-6"></div>
            <h2 class="text-3xl font-bold mb-4"> 砖 爪!</h2>
            <div id="submissionContent"></div>
            <button onclick="location.reload()" class="mt-8 text-blue-500 underline hover:text-blue-700">专 祝 转</button>
        </div>
    </div>

    <div id="view-teacher" class="view-section min-h-screen bg-slate-100 p-4 md:p-8 fade-in">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800"> 拽转 </h1>
                <button onclick="setView('quiz')" class="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700">爪</button>
            </div>
            <div id="submissionsList" class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                <table class="w-full text-right border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4 border-b">砖 转</th>
                            <th class="p-4 border-b"> 砖</th>
                            <th class="p-4 border-b">驻专拽</th>
                            <th class="p-4 border-b">住住</th>
                            <th class="p-4 border-b">驻注转</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody"></tbody>
                </table>
            </div>
            <div id="gradingPanel" class="hidden mt-8 bg-white rounded-2xl shadow-2xl p-6 md:p-8 border border-blue-200 fade-in"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-9NehHTUoE_vPzsiz4Y0LWgNC1-6W3C0",
        authDomain: "testnum1-kawitvemufason.firebaseapp.com",
        projectId: "testnum1-kawitvemufason",
        storageBucket: "testnum1-kawitvemufason.firebasestorage.app",
        messagingSenderId: "85481039106",
        appId: "1:85481039106:web:d82756601be5d3bc4e8e1b"
    };
    const TEACHER_PASSWORD = "1234";
    const appId = "testnum1-kawitvemufason";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentView = 'quiz';
    let selectedChapter = null;
    let submissions = [];
    let currentUser = null;
    let inspectingId = null;

    const americanQs = [
        {id: 'q1', q: ' 驻 转 拽爪 砖 注 砖 专砖转 专?', opts: ['.  注 砖砖 转.', '. 拽爪 砖砖 转  砖 注砖转 .', '.  砖转 爪 .', '. 专驻 .']},
        {id: 'q2', q: ' 驻  拽爪 专 砖注 砖 转转 注 ?', opts: ['. 驻住.', '. 驻.', '.  转驻.', '. 转拽 \'.']},
        {id: 'q3', q: '爪 注  砖 专驻 ?', opts: ['. 转   砖驻 .', '. 注 砖  专爪  注.', '.  拽砖 转 转 转 注 专驻.', '. 驻住 爪 注.']},
        {id: 'q4', q: ' 转 转 砖 注 砖 专转?', opts: ['.  .', '. .', '. 砖专.', '.  \'.']},
        {id: 'q5', q: '  住 砖 驻住 驻 注 砖?', opts: ['. 拽 住  .', '.    砖 转.', '.  专驻 砖 砖.', '. 住专 驻砖  拽转.']},
        {id: 'q6', q: '  驻住 注 爪爪 注转?', opts: ['. 砖 转 专  .', '. 拽 爪  注 .', '.  专注  专 住.', '. 驻 专驻 驻专住.']},
        {id: 'q7', q: ' 拽专     砖  转驻?', opts: ['. 爪  .', '. 专 爪 砖转驻转.', '. 注专 专 砖转 拽 .', '.  转转 专 .']},
        {id: 'q8', q: '转  转 转 "转驻转 住转 转专"?', opts: ['.  专 砖驻住 注.', '. 砖专 转祝 "驻住" "驻住".', '. 砖驻  .', '. 砖注 转转 注 专转.']},
        {id: 'q9', q: ' 拽 拽  转拽 \' 转 ?', opts: ['. 砖砖 拽.', '. 砖 拽.', '. 砖 拽.', '. 注砖专 拽.']},
        {id: 'q10', q: '   \' 驻 拽住?', opts: ['. 专 砖   砖砖  .', '.  驻住.', '.  砖  .', '. 专驻 砖 .']}
    ];

    const openQs = [
        "转专 转 转 砖 注 砖.   注专 爪 驻注 注 砖驻转?",
        "住专 转 专转 住驻专 砖  .  注转  驻注 爪专 住专转? 拽.",
        "  \"住\" 砖驻注 转拽驻转  转驻, 爪   转拽驻 驻转注?",
        "驻住 专: \"  注 砖    拽砖 拽抓 \".  砖注转?",
        "爪 砖转 住 砖 驻住 驻  专  专砖 ?",
        "  砖转专 拽住  专 \"驻住\"  专 \"驻住\"?",
        " 转拽 \' 爪注 专驻专 爪转. 住专  爪 驻注  砖 .",
        "爪 驻转 砖砖 转 砖 ( 转拽  ) 专 拽住.",
        "爪 砖驻注 拽砖专 砖   转拽    注  ?",
        " 拽驻拽 专  \"\" 爪爪 驻住  转驻转 专 专转?"
    ];

    const chapterA = {
        title: "砖驻转 ' ",
        american: [
            {id: 'pa_q1', q: '  砖 \'  砖  "-"?', opts: ['', '注', '专', '']},
            {id: 'pa_q2', q: ' 转 专   砖 10  砖转 专砖?', opts: ['砖专 砖驻转 驻住', '砖专   住转', ' 拽专转 砖驻 砖 ', ' 转  拽砖']},
            {id: 'pa_q3', q: ' 转 转 砖 专 砖转 砖, 专?', opts: ['住', '', '专', '']},
            {id: 'pa_q4', q: ' 注砖 住拽 拽专专 专 砖驻注   专?', opts: ['驻砖 转 住', '注专 专 注 住 专拽', '转 拽 注  住转', '转转 注 专']},
            {id: 'pa_q5', q: ' 专- 转?', opts: [' 砖 \' ', '住 专拽 砖砖 ', ' 砖 转 砖', '专 砖 住拽 拽专专']}
        ],
        open: [
            "爪 砖 '       砖驻 砖?",
            "转专 转  砖 砖 专.  砖    拽专 注  转?",
            "注 爪  专 转,   爪 驻 砖驻砖 转 住?",
            "  住 专,    砖 住?",
            "住专 转 转驻拽 砖 \" 住转\" 砖 住拽 拽专专 住驻专 砖 ."
        ]
    };

    const chapterB = {
        title: "砖驻转 ' 砖专",
        american: [
            {id: 'pb_q1', q: ' 转  专 砖 砖专 注 砖?', opts: ['爪专 注" 驻住', '注砖 拽专', '注 ', '转 ']},
            {id: 'pb_q2', q: '注 \'  注 专 住转 砖 砖转?', opts: ['  转', ' 注住拽 转  驻住 砖', '注祝 转 注 住', '  砖砖 拽专']},
            {id: 'pb_q3', q: ' 砖注 住专?', opts: ['注 砖 砖 拽专', ' 专砖注 砖驻注 ', '注 专砖,  注 ', ' 砖']},
            {id: 'pb_q4', q: ' 驻 砖 拽专驻, 注 砖 砖 拽专?', opts: ['住 注砖专', ' 抓', '注爪  注 专拽 转', '专驻 ']},
            {id: 'pb_q5', q: ' 转 住   拽砖专 砖 砖专?', opts: ['转 砖 \' 砖专', '砖 砖转 专注转 砖专 注专 专 转', '转 砖', '转 砖 拽专驻']}
        ],
        open: [
            "转专 转 注专转 住  ' 砖专.  住转专 专转 注住拽?",
            " 专 专专转 爪 专转 砖 拽专 专 砖 砖?",
            "住专 转  转 住专 砖 拽专 注 专砖 砖注 住专.",
            "注 住 专 砖 拽专 砖驻 转, 爪  ?",
            " 注  注 转 砖 转 转专 砖  砖 '?"
        ]
    };

    function renderQuiz() {
        const amContainer = document.getElementById('americanQuestions');
        amContainer.innerHTML = americanQs.map((q, i) => `
            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                <div class="grid md:grid-cols-2 gap-2">
                    ${q.opts.map(o => `
                        <label class="flex items-center gap-2 p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50">
                            <input type="radio" name="${q.id}" value="${o}" class="w-4 h-4">
                            <span class="text-sm">${o}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');

        const opContainer = document.getElementById('openQuestionsA');
        opContainer.innerHTML = openQs.map((q, i) => `
            <div class="space-y-2">
                <p class="font-bold">${i+1}. ${q}</p>
                <textarea name="open_a_${i}" class="w-full p-4 border rounded-xl min-h-[100px] focus:ring-2 focus:ring-blue-100 outline-none"></textarea>
            </div>
        `).join('');
    }

    function selectChapter(c) {
        selectedChapter = c;
        const data = c === 'A' ? chapterA : chapterB;
        document.getElementById('btnA').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'A' ? 'border-green-600 bg-green-50' : 'border-slate-100'}`;
        document.getElementById('btnB').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'B' ? 'border-green-600 bg-green-50' : 'border-slate-100'}`;
        
        const section = document.getElementById('chapterSection');
        section.classList.remove('hidden');
        section.innerHTML = `
            <h3 class="text-xl font-bold text-green-800 text-center mb-4 underline">${data.title}</h3>
            <div class="space-y-6">
                <p class="font-bold text-slate-700">砖转 专拽转 驻专拽 :</p>
                ${data.american.map((q, i) => `
                    <div class="p-4 bg-white rounded-xl border border-green-100">
                        <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                        <div class="grid md:grid-cols-2 gap-2">
                            ${q.opts.map(o => `
                                <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border cursor-pointer hover:bg-green-50">
                                    <input type="radio" name="${q.id}" value="${o}" class="w-4 h-4">
                                    <span class="text-sm">${o}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                
                <p class="font-bold text-slate-700 mt-8">砖转 驻转转 驻专拽 :</p>
                ${data.open.map((q, i) => `
                    <div class="space-y-2">
                        <p class="font-bold">${i+1}. ${q}</p>
                        <textarea name="open_b_${i}" class="w-full p-4 border rounded-xl min-h-[100px] outline-none bg-white"></textarea>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Auth & Persistence Logic (Same as updated version)
    const initApp = async () => {
        try {
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            setupRealtimeSubmissions();
        } catch (err) { console.error(err); setTimeout(initApp, 2000); }
    };

    function setView(newView) {
        currentView = newView;
        document.querySelectorAll('.view-section').forEach(div => div.classList.remove('active'));
        document.getElementById(`view-${newView}`).classList.add('active');
        if (newView === 'submitted') renderSubmissionStatus();
        if (newView === 'teacher') renderSubmissionsTable();
    }

    function setupRealtimeSubmissions() {
        if (!currentUser) return;
        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions')
            .onSnapshot(snap => {
                submissions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                submissions.sort((a,b) => b.timestamp - a.timestamp);
                if (currentView === 'teacher') renderSubmissionsTable();
                if (currentView === 'submitted') renderSubmissionStatus();
            });
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        if (!selectedChapter) return alert(" 专 驻专拽 拽 '");
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "砖...";
        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').add({
                studentName: data.studentName,
                timestamp: Date.now(),
                responses: data,
                chapter: selectedChapter,
                userId: currentUser.uid
            });
            setView('submitted');
        } catch (err) { alert(err.message); btn.disabled = false; }
    }

    // Teacher & Status functions same as before...
    function renderSubmissionsTable() {
        const body = document.getElementById('submissionsTableBody');
        body.innerHTML = submissions.map(s => `
            <tr class="border-b">
                <td class="p-4 font-bold">${s.studentName}</td>
                <td class="p-4">${new Date(s.timestamp).toLocaleTimeString()}</td>
                <td class="p-4 text-center">${s.chapter}</td>
                <td class="p-4">${s.finalGrade ? '拽' : '转'}</td>
                <td class="p-4"><button onclick="inspectSubmission('${s.id}')" class="bg-blue-600 text-white px-3 py-1 rounded">拽</button></td>
            </tr>
        `).join('');
    }

    function inspectSubmission(id) {
        const sub = submissions.find(s => s.id === id);
        inspectingId = id;
        document.getElementById('submissionsList').classList.add('hidden');
        const panel = document.getElementById('gradingPanel');
        panel.classList.remove('hidden');
        panel.innerHTML = `
            <div class="flex justify-between mb-4">
                <h2 class="text-2xl font-bold">转砖转 砖 ${sub.studentName}</h2>
                <button onclick="closeGrading()" class="text-red-500">住专 X</button>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="max-h-[60vh] overflow-y-auto space-y-4">
                    ${Object.entries(sub.responses).map(([k,v]) => `<div class="p-2 border-b"><b>${k}:</b> <p>${v}</p></div>`).join('')}
                </div>
                <div class="bg-slate-50 p-4 rounded">
                    <textarea id="tFeedback" class="w-full h-32 border p-2 mb-2" placeholder="注专转...">${sub.teacherFeedback || ''}</textarea>
                    <input id="tGrade" type="number" class="w-full border p-2 mb-2" placeholder="爪" value="${sub.finalGrade || ''}">
                    <button onclick="saveGrading()" class="w-full bg-green-600 text-white p-4 font-bold rounded">砖专 爪</button>
                </div>
            </div>
        `;
    }

    function closeGrading() {
        document.getElementById('gradingPanel').classList.add('hidden');
        document.getElementById('submissionsList').classList.remove('hidden');
    }

    async function saveGrading() {
        const grade = document.getElementById('tGrade').value;
        const feedback = document.getElementById('tFeedback').value;
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').doc(inspectingId).update({
            finalGrade: grade,
            teacherFeedback: feedback
        });
        alert("砖专!");
        closeGrading();
    }

    function handleTeacherAccess() {
        if (document.getElementById('passInput').value === TEACHER_PASSWORD) setView('teacher');
        else alert("注转");
    }

    function renderSubmissionStatus() {
        const container = document.getElementById('submissionContent');
        const mySub = submissions.find(s => s.userId === currentUser.uid);
        if (mySub && mySub.finalGrade) {
            container.innerHTML = `<div class="bg-blue-50 p-4 rounded border-2 border-blue-200"><p class="text-3xl font-bold">爪: ${mySub.finalGrade}</p><p class="mt-2">${mySub.teacherFeedback || ''}</p></div>`;
        } else {
            container.innerHTML = `<p> 砖 转 拽.</p>`;
        }
    }

    window.onload = () => { renderQuiz(); initApp(); };
</script>

</body>
</html>
