<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××‘×—×Ÿ ×‘×›×•×™×ª ×•××•×¤×¡×•×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

<div id="app">
    <!-- Quiz Interface -->
    <div id="view-quiz" class="view-section py-10 px-4 active">
        <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-3xl overflow-hidden border border-slate-200">
            <div class="bg-blue-800 text-white p-8 text-center relative">
                <div class="text-sm font-bold mb-2 opacity-80">×‘"×”</div>
                <h1 class="text-4xl font-black mb-2">××‘×—×Ÿ ×‘×›×•×™×ª ×•××•×¤×¡×•×Ÿ</h1>
                <p class="text-blue-100 italic">"×ª×œ××™×“×™× ×™×§×¨×™×, ×™×© ×œ×¢× ×•×ª ×¨×§ ×¢×œ ××¡×¤×¨ ×”×©××œ×•×ª ×”× ×“×¨×© ×‘×›×œ ×—×œ×§!"</p>
                
                <div class="mt-6 pt-4 border-t border-blue-700/50 flex flex-col items-center">
                    <div class="flex gap-2">
                        <input id="passInput" type="password" placeholder="×¡×™×¡××ª ××•×¨×”" class="text-black text-xs p-1 rounded w-24 outline-none">
                        <button onclick="handleTeacherAccess()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded">×›× ×™×¡×ª ××•×¨×”</button>
                    </div>
                </div>
            </div>

            <form id="quizForm" onsubmit="handleFormSubmit(event)" class="p-8 space-y-12">
                <section class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <label class="block text-lg font-bold mb-2">×©× ××œ×: <span class="text-red-500">*</span></label>
                    <input required name="studentName" id="studentNameField" type="text" class="w-full md:w-1/2 p-3 rounded-xl border border-blue-200 outline-none focus:ring-4 focus:ring-blue-100" placeholder="×”×›× ×¡ ××ª ×©××š...">
                </section>

                <!-- Part A -->
                <section>
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-blue-800 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">×</span>
                        <h2 class="text-2xl font-bold text-slate-800">×—×œ×§ ×': ×”×˜×•×‘×™× ×•×”×¤×™×¡×˜×™× (50 × ×§×•×“×•×ª)</h2>
                    </div>
                    
                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-blue-700 underline">×©××œ×•×ª ×××¨×™×§××™×•×ª (×¢× ×” ×¢×œ 7 ×‘×œ×‘×“)</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">20 × ×§×•×“×•×ª</span>
                            </div>
                            <div id="americanQuestions" class="space-y-6"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-blue-700 underline">×©××œ×•×ª ×¤×ª×•×—×•×ª (×¢× ×” ×¢×œ 6 ×‘×œ×‘×“)</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">30 × ×§×•×“×•×ª</span>
                            </div>
                            <div id="openQuestionsA" class="space-y-6"></div>
                        </div>
                    </div>
                </section>

                <!-- Part B -->
                <section class="border-t pt-12">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">×‘</span>
                        <h2 class="text-2xl font-bold text-slate-800">×—×œ×§ ×‘': ×¦××¦××™ ×”××œ×š ××ª×•×§ ×‘×•×’'×™ (50 × ×§×•×“×•×ª)</h2>
                    </div>
                    <p class="mb-6 text-slate-600 font-medium italic">×‘×—×¨ ××—×“ ××”×¤×¨×§×™× ×”×‘××™× ×•×¢× ×” ×¢×œ ×›×œ ×”×©××œ×•×ª ×©×‘×•:</p>
                    
                    <div class="flex flex-col md:flex-row gap-4 mb-10 text-center">
                        <button type="button" onclick="selectChapter('A')" id="btnA" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">×¤×¨×§ ×'</h4>
                            <p class="text-sm">××©×¤×—×ª ×–'××–×Ÿ ×•××™×›×œ</p>
                        </button>
                        <button type="button" onclick="selectChapter('B')" id="btnB" class="flex-1 p-6 rounded-2xl border-4 transition border-slate-100">
                            <h4 class="text-xl font-black">×¤×¨×§ ×‘'</h4>
                            <p class="text-sm">××©×¤×—×ª ×’×™'×’×™ ×•×©×™×¨×”</p>
                        </button>
                    </div>
                    <div id="chapterSection" class="hidden bg-green-50/30 p-6 rounded-3xl border border-green-100 space-y-6 fade-in"></div>
                </section>

                <button type="submit" id="submitBtn" class="w-full py-6 rounded-full text-2xl font-black text-white shadow-2xl transition transform hover:scale-[1.02] active:scale-95 bg-blue-700 hover:bg-blue-800">
                    ×©×œ×— ××‘×—×Ÿ ×¡×•×¤×™ ×œ×‘×“×™×§×”
                </button>
            </form>
        </div>
    </div>

    <!-- Submitted View -->
    <div id="view-submitted" class="view-section min-h-screen bg-slate-50 flex items-center justify-center p-6 fade-in">
        <div id="statusCard" class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl text-center max-w-2xl border-t-8 border-green-500 w-full">
            <div class="text-7xl mb-6">ğŸ†</div>
            <h2 class="text-3xl font-bold mb-4">×”××‘×—×Ÿ ×”×•×’×© ×‘×”×¦×œ×—×”!</h2>
            <div id="submissionContent" class="my-6"></div>
            <div class="flex flex-col gap-3 items-center">
                <button onclick="resetForNewTest()" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold hover:bg-blue-700 transition">×”×ª×—×œ ××‘×—×Ÿ ×—×“×© / × ×¡×” ×©×•×‘</button>
                <button onclick="setView('quiz')" class="text-slate-500 underline hover:text-slate-800">×¦×¤×™×™×” ×‘×ª×©×•×‘×•×ª×™×™ (×§×¨×™××” ×‘×œ×‘×“)</button>
            </div>
        </div>
    </div>

    <!-- Teacher View -->
    <div id="view-teacher" class="view-section min-h-screen bg-slate-100 p-4 md:p-8 fade-in">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">× ×™×”×•×œ ×•×‘×“×™×§×ª ××‘×—× ×™×</h1>
                <button onclick="setView('quiz')" class="bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-700">×™×¦×™××”</button>
            </div>
            <div id="submissionsList" class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                <table class="w-full text-right border-collapse">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4 border-b">×©× ×”×ª×œ××™×“</th>
                            <th class="p-4 border-b">×–××Ÿ ×”×’×©×”</th>
                            <th class="p-4 border-b">×¤×¨×§</th>
                            <th class="p-4 border-b">×¡×˜×˜×•×¡</th>
                            <th class="p-4 border-b">×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody"></tbody>
                </table>
            </div>
            <div id="gradingPanel" class="hidden mt-8 bg-white rounded-2xl shadow-2xl p-6 md:p-8 border border-blue-200 fade-in"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC-9NehHTUoE_vPzsiz4Y0LWgNC1-6W3C0",
        authDomain: "testnum1-kawitvemufason.firebaseapp.com",
        projectId: "testnum1-kawitvemufason",
        storageBucket: "testnum1-kawitvemufason.firebasestorage.app",
        messagingSenderId: "85481039106",
        appId: "1:85481039106:web:d82756601be5d3bc4e8e1b"
    };
    const TEACHER_PASSWORD = "1234";
    const appId = "testnum1-kawitvemufason";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentView = 'quiz';
    let selectedChapter = null;
    let submissions = [];
    let currentUser = null;
    let inspectingId = null;

    // --- ××‘× ×” ×”×©××œ×•×ª ---
    const americanQs = [
        {id: 'q1', q: '××” ××¤×™×™×Ÿ ××ª ×”×§×‘×•×¦×” ×©×”× ×”×™×’ × ×¢×™× ×©××›× ×‘×¨××©×™×ª ×“×¨×›×”?', opts: ['×. ×”× ×”×™×• ×œ×•×—××™× ×¢×–×™× ×©×›×‘×©×• ×××œ×›×•×ª.', '×‘. ×”× ×”×™×• ×§×‘×•×¦×” ×©×©× ××” ××œ×—××•×ª ×•××”×‘×” ×©×œ×•× ×•×¢×©×™×™×ª ×˜×•×‘.', '×’. ×”× ×”×™×• ×“×™×™×’×™× ×©×”×ª××—×• ×‘×¦×œ×™×œ×” ×‘×™×.', '×“. ×”× ×”×™×• ×¨×•×¤××™× × ×•×“×“×™×.']},
        {id: 'q2', q: '××™ ×”×¤×š ×œ×× ×”×™×’ ×”×§×‘×•×¦×” ×œ××—×¨ ×©× ×¢×™× ×©××›× ×”×ª×—×ª×Ÿ ×¢× × × ×™?', opts: ['×. ×¤×¡×˜×•×Ÿ.', '×‘. ×¤×•× ×™.', '×’. ××‘×™ ×ª×¤×•×—.', '×“. ××ª×•×§ ×‘×•×’\'×™.']},
        {id: 'q3', q: '×›×™×¦×“ ×”×’×™×¢×” × × ×™ ×œ×”×™× ×©× ×œ×¨×•×¤× × ×•× ×Ÿ?', opts: ['×. ×”×™× ×”×ª××”×‘×” ×‘×• ×‘×–××Ÿ ×©×˜×™×¤×œ ×‘×”.', '×‘. × ×¢×™× ×©××›× ×œ× ×¨×¦×” ×‘×” ×™×•×ª×¨.', '×’. × ×•× ×Ÿ ×‘×™×§×© ×–××ª ×›××•×ª ×ª×•×“×” ×¢×œ ×›×š ×©×¨×™×¤× ××•×ª×” ×××—×œ×ª×”.', '×“. ×¤×¡×˜×•×Ÿ ×¦×™×•×•×” ×¢×œ×™×” ×œ×¢×©×•×ª ×–××ª.']},
        {id: 'q4', q: '××™ ×”×™×™×ª×” ×‘×ª× ×©×œ × ×¢×™× ×©××›× ×•×¨×•×ª×™?', opts: ['×. ××œ×›×” ×œ××”.', '×‘. ×‘×™×™× ×”.', '×’. ×©×™×¨×”.', '×“. ×–×™×™× ×™ ×‘×•×’\'×™.']},
        {id: 'q5', q: '××” ×”×™×” ×™×—×¡×• ×©×œ ×¤×¡×˜×•×Ÿ ×›×œ×¤×™ × ×¢×™× ×©××›×?', opts: ['×. ×”×•× ×§×™× × ×‘×• ×•× ×™×¡×” ×œ×”×™×œ×—× ×‘×•.', '×‘. ×”×•× ×”×™×” ××“× × ×“×™×‘ ×©××”×‘ ××ª × ×¢×™× ×©××›× ×××•×“.', '×’. ×”×•× ×”×™×” ×”×¨×•×¤× ×”××™×©×™ ×©×œ ××©×¤×—×ª×•.', '×“. ×”×•× ×¡×™×¨×‘ ×œ×”×™×¤×’×© ××™×ª×• ×‘×’×œ×œ ×”××—×œ×•×§×•×ª ×‘×™×Ÿ ×”×§×‘×•×¦×•×ª.']},
        {id: 'q6', q: '××” × ×™×‘× ×¤×¡×˜×•×Ÿ ×¢×œ ×¦××¦××™×• ×”×¢×ª×™×“×™×™×?', opts: ['×. ×©×”× ×™××©×™×›×• ××ª ×“×¨×›×• ×•×™×”×™×• × ×“×™×‘×™× ×œ×˜×•×‘×™×.', '×‘. ×©×”× ×™×§×™××• ×¦×‘× ×××•×—×“ ×™×—×“ ×¢× ×”×˜×•×‘×™×.', '×’. ×©×”× ×™×”×™×• ×¨×¢×™× ×œ×˜×•×‘×™×, ×™×’×¨××• ×œ×”× ×¡×‘×œ ×•××•×œ×™ ××£ ×™×”×¨×’×• ×—×œ×§ ××”×.', '×“. ×©×¦××¦××™×• ×™×”×¤×›×• ×œ×¨×•×¤××™× ××¤×•×¨×¡××™× ×›××• × ×•× ×Ÿ.']},
        {id: 'q7', q: '××” ×§×¨×” ×œ×›×œ ×”×˜×•×‘×™× ×‘××”×œ×š ×”×”× ×”×’×” ×©×œ ××‘×™ ×ª×¤×•×—?', opts: ['×. ×”× ×™×¦××• ×œ××œ×—××” ×™×–×•××” × ×’×“ ×”×¤×¡×˜×™×.', '×‘. ×”× ××™×¨×’× ×• ×¦×œ×™×œ×” ××©×•×ª×¤×ª ×‘×™× ×”×¡××•×š ×œ×××œ×›×”.', '×’. ×”× ×¢×‘×¨×• ×œ×’×•×¨ ×‘×—××©×ª ×—×œ×§×™ ×”×××œ×›×”.', '×“. ×”× ×—×’×’×• ××ª ×—×ª×•× ×ª× ×©×œ ××¨×“×›×™ ×•×‘×™×™× ×”.']},
        {id: 'q8', q: '××ª×™ ×”×—×œ×• ×”××œ×—××•×ª ×œ×”×™×•×ª "×ª×›×•×¤×•×ª ×•××¡×•×›× ×•×ª ×™×•×ª×¨"?', opts: ['×. ××™×“ ×œ××—×¨ ×©×¤×¡×˜×•×Ÿ × ×¢×œ×.', '×‘. ×‘×ª×§×•×¤×” ×©×‘×” ×”×“×•×¨ ×”×ª×—×œ×£ ×"×¤×¡×˜×™" ×œ"×¤×™×¡×˜×™".', '×’. ×›×©×¤×•× ×™ ×”×™×” ×”×× ×”×™×’.', '×“. ×›×©× ×¢×™× ×©××›× ×”×ª×—×ª×Ÿ ×¢× ×¨×•×ª×™.']},
        {id: 'q9', q: '×œ×›××” ×—×œ×§×™× ×—×™×œ×§ ×”××œ×š ××ª×•×§ ×‘×•×’\'×™ ××ª ×”×××œ×›×”?', opts: ['×. ×œ×©×œ×•×©×” ×—×œ×§×™×.', '×‘. ×œ×©× ×™ ×—×œ×§×™× (×˜×•×‘×™× ×•×¤×¡×˜×™×).', '×’. ×œ×—××™×©×” ×—×œ×§×™×.', '×“. ×œ×¢×©×¨×” ×—×œ×§×™×.']},
        {id: 'q10', q: '××™×”× ×“×•×“ ×•×–×™×™× ×™ ×‘×•×’\'×™ ×œ×¤×™ ×”×˜×§×¡×˜?', opts: ['×. ×”×•×¨×™×”× ×©×œ ×›×œ ×‘× ×™ ×”×–×•×’ ×©× ×™×©××• ×œ×™×œ×“×™×• ×©×œ ×”××œ×š ××ª×•×§.', '×‘. ×”×× ×”×™×’×•×ª ×©×œ ×§×‘×•×¦×ª ×”×¤×™×¡×˜×™×.', '×’. ×”×™×œ×“×™× ×©×œ ××œ×›×” ×œ××”.', '×“. ×”×¨×•×¤××™× ×©×˜×™×¤×œ×• ×‘× × ×™.']}
    ];

    const openQs = [
        "×ª××¨ ××ª ×“××•×ª×• ×©×œ × ×¢×™× ×©××›×. ××” ×”×™×• ×¢×¨×›×™×• ×•×›×™×¦×“ ×¤×¢×œ ×œ××¢×Ÿ ××©×¤×—×ª×•?",
        "×”×¡×‘×¨ ××ª ×”××•×¨×›×‘×•×ª ×‘×¡×™×¤×•×¨ ×©×œ × × ×™ ×•× ×•× ×Ÿ. ×”×× ×œ×“×¢×ª×š × ×•× ×Ÿ ×¤×¢×œ ×‘×¦×•×¨×” ××•×¡×¨×™×ª? × ××§.",
        "××” ×”×™×” \"×”×¡×™××Ÿ\" ×©×”×•×¤×™×¢ ×‘×ª×§×•×¤×ª ××‘×™ ×ª×¤×•×—, ×•×›×™×¦×“ ×”×’×™×‘×• ×”×˜×•×‘×™× ×œ×”×ª×§×¤×” ×”××¤×ª×™×¢×”?",
        "×¤×¡×˜×•×Ÿ ×××¨: \"×‘×™×•× ××Ÿ ×”××•×¢×“×™× ××©×•×‘ ×’× ×× ×™ ××œ ×”××•×§×© ×•××§×¥ ×”×›×œ\". ××” ×”××©××¢×•×ª ×œ×“×¢×ª×š?",
        "×›×™×¦×“ ×”×©×ª× ×” ×”×™×—×¡ ×©×œ ×”×¤×¡×˜×™× ×›×œ×¤×™ ×”×˜×•×‘×™× ×œ××—×¨ ×”××œ×—××” ×”×¨××©×•× ×” ×‘×™×?",
        "××”×• ×”×”×‘×“×œ ×©××ª×•××¨ ×‘×˜×§×¡×˜ ×‘×™×Ÿ ×“×•×¨ ×”\"×¤×¡×˜×™\" ×œ×‘×™×Ÿ ×“×•×¨ ×”\"×¤×™×¡×˜×™\"?",
        "×”××œ×š ××ª×•×§ ×‘×•×’'×™ ×‘×™×¦×¢ ×¨×¤×•×¨××” ×¦×‘××™×ª. ×”×¡×‘×¨ ××™×š ×”×¦×‘× ×¤×•×¢×œ ×‘×–××Ÿ ×©×œ×•× ×•×‘××œ×—××”.",
        "×¦×™×™×Ÿ ×œ×¤×—×•×ª ×©×œ×•×©×” ××–×•×’×•×ª ×”×©×œ×™×˜×™× (×™×œ×“×™ ××ª×•×§ ×•×‘× ×™ ×–×•×’×) ×”××•×–×›×¨×™× ×‘×˜×§×¡×˜.",
        "×›×™×¦×“ ×”×©×¤×™×¢×• ×§×©×¨×™ ×”× ×™×©×•××™×Ÿ ×‘×™×Ÿ ×™×œ×“×™ ××ª×•×§ ×œ×™×œ×“×™ ×“×•×“ ×•×–×™×™× ×™ ×¢×œ × ×™×”×•×œ ×”×××œ×›×”?",
        "××”×• ×”×§×•× ×¤×œ×™×§×˜ ×”××¨×›×–×™ ×‘×¡×™×¤×•×¨ ×‘×™×Ÿ ×§×‘×•×¦×ª ×”\"×˜×•×‘×™×\" ×œ×¦××¦××™ ×¤×¡×˜×•×Ÿ ×•××™×š ×”×ª×¤×ª×—?"
    ];

    const chapterA = {
        title: "×¤×¨×§ ×': ××©×¤×—×ª ×–'××–×Ÿ ×•××™×›×œ",
        american: [
            {id: 'pa_q1', q: '××™ ××™×œ×“×™×”× ×©×œ ×–\'××–×Ÿ ×•××™×›×œ × ×™×©××” ×œ××œ×š "×›×—×•×œ-×™×"?', opts: ['×. ××™×œ× ×”.', '×‘. × ×¢×”.', '×’. ×“×‘×•×¨×”.', '×“. ×—× ×”.']},
            {id: 'pa_q2', q: '××” ×”×ª×’×œ×” ×œ×‘××¨×™ ×‘××”×œ×š ×”×œ×™×“×” ×©×œ 10 ×™×œ×“×™×• ×××©×ª×• ×”×¨××©×•× ×”?', opts: ['×. ×©×¨×“×•×‘×™×œ×” ×”×™× ×‘×¢×¦× ×××©×¤×—×ª ×”×¤×™×¡×˜×™×.', '×‘. ×©×¨×“×•×‘×™×œ×” ×œ× ×¡×™×¤×¨×” ×œ×• ×©×”×™× ×“×•×‘×” ××¡×•×›× ×ª.', '×’. ×©×¨×“×•×‘×™×œ×” ×”×™× ×§×¨×•×‘×ª ××©×¤×—×” ×©×œ ×”××œ×š ××’× ×•×.', '×“. ×©×¨×“×•×‘×™×œ×” ×—×œ×ª×” ×‘××—×œ×” ×§×©×”.']},
            {id: 'pa_q3', q: '××™ ×”×™×™×ª×” ×”×‘×ª ×©× ×•×œ×“×” ×œ×‘××¨×™ ×××©×ª×• ×”×©× ×™×™×”, ××¨×™×?', opts: ['×. ×¡×™××”.', '×‘. ××™×œ× ×”.', '×’. ×“×‘×•×¨×”.', '×“. ×—× ×”.']},
            {id: 'pa_q4', q: '××” ×¢×©×” ×¡×™×§ ×§×¨××¨ ×œ××—×¨ ×©×¤×’×¢ ×‘××™×œ× ×” ×•×”×™× ×‘×¨×—×”?', opts: ['×. ×”×•× ×—×™×¤×© ××•×ª×” ×‘×¨×—×•×‘×•×ª.', '×‘. ×”×•× ×¢×‘×¨ ×œ×’×•×¨ ×¢× × ×¡×™×š ×”×“×¨×‘× ×™×§×œ×™×.', '×’. ×”×•× ×ª×›× ×Ÿ × ×§××” ×‘××™×œ× ×” ×™×—×“ ×¢× ×××• ×•×¡×‘×ª×•.', '×“. ×”×•× ×”×ª×—×ª×Ÿ ×¢× ×¨×“×•×‘×™×œ×” ×‘×œ×§×Ÿ.']},
            {id: 'pa_q5', q: '××™×”×• ××“×•××¨×“-×“×•×“ ×ª× ×•×Ÿ?', opts: ['×. ×‘× × ×©×œ ×–\'××–×Ÿ ×•××™×›×œ.', '×‘. × ×¡×™×š ×”×“×¨×‘× ×™×§×œ×™× ×©× ×™×©× ×œ××™×œ× ×”.', '×’. ×”××œ×š ×©×œ ×××œ×›×ª ×“×•×•×©×”.', '×“. ×—×‘×¨×• ×”×˜×•×‘ ×‘×™×•×ª×¨ ×©×œ ×¡×™×§ ×§×¨××¨.']}
        ],
        open: [
            "×›×™×¦×“ ×©×™×œ×‘×• ×–'××–×Ÿ ×•××™×›×œ ×‘×™×Ÿ × ×™×”×•×œ ×”×××œ×›×” ×œ×‘×™×Ÿ ×—×™×™ ×”××©×¤×—×”?",
            "×ª××¨ ××ª ×’×œ×’×•×œ×™ ×”× ×™×©×•××™×Ÿ ×©×œ ×‘××¨×™. ×›××” × ×©×™× ×”×™×• ×œ×• ×•××” ×§×¨×”?",
            "××“×•×¢ × ××œ×¦×” ××™×œ× ×” ×œ×‘×¨×•×— ××‘×™×ª×”, ×•××” ×”×™×” ××¦×‘×” ×œ×¤× ×™ ×©×¤×’×©×” ××ª ×”× ×¡×™×š?",
            "××™ ×”×™×• ×¡×™××” ×•×’×’×¨×, ×•××™ ×”×™×” ×‘× × ×©×œ ×¡×™××”?",
            "×”×¡×‘×¨ ××ª ×ª×¤×§×™×“×Ÿ ×©×œ \"×××• ×•×¡×‘×ª×•\" ×©×œ ×¡×™×§ ×§×¨××¨ ×‘×¡×™×¤×•×¨×” ×©×œ ××™×œ× ×”."
        ]
    };

    const chapterB = {
        title: "×¤×¨×§ ×‘': ××©×¤×—×ª ×’×™'×’×™ ×•×©×™×¨×”",
        american: [
            {id: 'pb_q1', q: '××” ×”×™×™×ª×” ×”×××•× ×” ×”××•×–×¨×” ×©×œ ×©×™×¨×” ×‘× ×•×’×¢ ×œ×—×©××œ?', opts: ['×. ×©×—×©××œ ××™×•×¦×¨ ×¢"×™ ×”×¤×™×¡×˜×™×.', '×‘. ×©×—×©××œ ×¢×©×•×™ ××§×™×¨.', '×’. ×©×—×©××œ ××’×™×¢ ××”×™×.', '×“. ×©×—×©××œ ×”×•× ××ª× ×”.']},
            {id: 'pb_q2', q: '××“×•×¢ ×’×™\'×’×™ ×œ× ×”×’×™×¢ ×œ×¨×•×‘ ×”××¡×™×‘×•×ª ×©×œ ××©×ª×•?', opts: ['×. ×›×™ ×œ× ××”×‘ ××ª ×©×™×¨×”.', '×‘. ×›×™ ×”×™×” ×¢×¡×•×§ ×‘××œ×—××•×ª × ×’×“ ×”×¤×™×¡×˜×™× ×•×××œ×›×ª ×“×•×•×©×”.', '×’. ×›×™ ×”×¢×“×™×£ ×œ×‘×œ×•×ª ×¢× ×¡× ×“×™.', '×“. ×›×™ ×œ× ×”×××™×Ÿ ×©×—×©××œ ××§×™×¨.']},
            {id: 'pb_q3', q: '××™×”×• ×©××¢×•×Ÿ ×¡×¨×’×œ×™?', opts: ['×. ×‘×¢×œ×” ×”×©× ×™ ×©×œ ×§×¨×•×œ×™×Ÿ.', '×‘. ××“× ×¨×©×¢ ×©×¤×’×¢ ×‘×”.', '×’. ×‘×¢×œ×” ×”×¨××©×•×Ÿ, ×©×”×™×” ××“× ×•×‘×¢×œ ×˜×•×‘.', '×“. ×× ×”×™×’ ×××œ×›×ª ×“×•×•×©×”.']},
            {id: 'pb_q4', q: '××”× ×”×××¤×™×™× ×™× ×©×œ ×§×¨×¤×“×”, ×‘×¢×œ×” ×”×©× ×™ ×©×œ ×§×¨×•×œ×™×Ÿ?', opts: ['×. × ×¡×™×š ×¢×©×™×¨ ×•× ×“×™×‘.', '×‘. ×œ×•×—× ×××™×¥.', '×’. ××“× ×¢×¦×œ×Ÿ ×•××•×–× ×— ×©×”×›×™×Ÿ ×œ×” ××¨×§ × ×–×œ×ª.', '×“. ×¨×•×¤× ××•××—×”.']},
            {id: 'pb_q5', q: '××™ ×”×™×™×ª×” ×¡× ×“×™ ×•××” ×”×™×” ×”×§×©×¨ ×©×œ×” ×œ×©×™×¨×”?', opts: ['×. ×”×‘×ª ×©×œ ×’×™\'×’×™ ×•×©×™×¨×”.', '×‘. ××™×©×” ×©×ª××›×” ×‘×¨×¢×™×•× ×•×ª ×©×™×¨×” ×•×¢×‘×¨×” ×œ×’×•×¨ ××™×ª×”.', '×’. ×”××œ×›×” ×©×œ ×××œ×›×ª ×“×•×•×©×”.', '×“. ×”××—×•×ª ×©×œ ×§×¨×¤×“×”.']}
        ],
        open: [
            "×ª××¨ ××ª ××¢×¨×›×ª ×”×™×—×¡×™× ×‘×™×Ÿ ×’×™'×’×™ ×œ×©×™×¨×”. ××™×š ×”×¡×ª×“×¨×•?",
            "××” ×’×¨× ×œ×”×™×“×¨×“×¨×•×ª ×‘××¦×‘×” ×”×‘×¨×™××•×ª×™ ×©×œ ×§×¨×•×œ×™×Ÿ ×œ××—×¨ × ×™×©×•××™×” ×”×©× ×™×™×?",
            "×”×¡×‘×¨ ××ª ×”××”×œ×š ×”×‘×œ×ª×™ ××•×¡×‘×¨ ×©×œ ×§×¨×•×œ×™×Ÿ ×‘× ×•×’×¢ ×œ×’×™×¨×•×©×™×” ××©××¢×•×Ÿ ×¡×¨×’×œ×™.",
            "××“×•×¢ × ×™×¡×• ×”×•×¨×™×” ×©×œ ×§×¨×•×œ×™×Ÿ ×œ××©×¤×– ××•×ª×”, ×•×›×™×¦×“ ×”×’×™×‘×”?",
            "××” ×™×“×•×¢ ×œ× ×• ×¢×œ ×××œ×›×ª ×“×•×•×©×” ××ª×•×š ×”×ª×™××•×¨ ×©×œ ×—×™×™×• ×©×œ ×’×™'×’×™?"
        ]
    };

    function setView(newView) {
        currentView = newView;
        document.querySelectorAll('.view-section').forEach(div => div.classList.remove('active'));
        document.getElementById(`view-${newView}`).classList.add('active');
        
        if (newView === 'submitted') renderSubmissionStatus();
        if (newView === 'teacher') renderSubmissionsTable();
        window.scrollTo(0, 0);
    }

    async function initApp() {
        try {
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            setupRealtimeSubmissions();
            renderQuiz();
        } catch (err) {
            console.error("Auth Error:", err);
            setTimeout(initApp, 2000);
        }
    }

    function setupRealtimeSubmissions() {
        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions')
            .onSnapshot(snap => {
                submissions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ×ª×™×§×•×Ÿ: ×”×‘×“×™×§×” ×”××•×˜×•××˜×™×ª ××ª×‘×¦×¢×ª ×¨×§ ×× ×”××©×ª××© ×œ× × ××¦× ×›×¨×’×¢ ×‘×ª×¦×•×’×ª ××•×¨×”
                if (currentView !== 'teacher') {
                    const mySub = submissions.find(s => s.userId === currentUser.uid);
                    if (mySub && currentView === 'quiz') {
                        setView('submitted');
                    }
                }
            }, (error) => console.error("Firestore error:", error));
    }

    function renderQuiz() {
        const amContainer = document.getElementById('americanQuestions');
        amContainer.innerHTML = americanQs.map((q, i) => `
            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                <div class="grid md:grid-cols-2 gap-2">
                    ${q.opts.map(o => `
                        <label class="flex items-center gap-2 p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50">
                            <input type="radio" name="${q.id}" value="${o}" class="w-4 h-4">
                            <span class="text-sm">${o}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');

        const opContainer = document.getElementById('openQuestionsA');
        opContainer.innerHTML = openQs.map((q, i) => `
            <div class="space-y-2">
                <p class="font-bold">${i+1}. ${q}</p>
                <textarea name="open_a_${i}" class="w-full p-4 border rounded-xl min-h-[100px] focus:ring-2 focus:ring-blue-100 outline-none"></textarea>
            </div>
        `).join('');
    }

    function selectChapter(c) {
        selectedChapter = c;
        const data = c === 'A' ? chapterA : chapterB;
        document.getElementById('btnA').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'A' ? 'border-green-600 bg-green-50 shadow-inner' : 'border-slate-100'}`;
        document.getElementById('btnB').className = `flex-1 p-6 rounded-2xl border-4 transition ${c === 'B' ? 'border-green-600 bg-green-50 shadow-inner' : 'border-slate-100'}`;
        
        const section = document.getElementById('chapterSection');
        section.classList.remove('hidden');
        section.innerHTML = `
            <h3 class="text-xl font-bold text-green-800 text-center mb-4 underline">${data.title}</h3>
            <div class="space-y-6">
                ${data.american.map((q, i) => `
                    <div class="p-4 bg-white rounded-xl border border-green-100">
                        <p class="font-bold mb-3">${i+1}. ${q.q}</p>
                        <div class="grid md:grid-cols-2 gap-2">
                            ${q.opts.map(o => `
                                <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border cursor-pointer hover:bg-green-50">
                                    <input type="radio" name="${q.id}" value="${o}" class="w-4 h-4">
                                    <span class="text-sm">${o}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                ${data.open.map((q, i) => `
                    <div class="space-y-2">
                        <p class="font-bold">${i+1}. ${q}</p>
                        <textarea name="open_b_${i}" class="w-full p-4 border rounded-xl min-h-[100px] outline-none bg-white"></textarea>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        if (!selectedChapter) return alert("×× × ×‘×—×¨ ×¤×¨×§ ×‘×—×œ×§ ×‘'");
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "×©×•×œ×— ××‘×—×Ÿ...";

        const formData = new FormData(e.target);
        const responses = Object.fromEntries(formData.entries());

        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').add({
                studentName: responses.studentName,
                timestamp: Date.now(),
                responses: responses,
                chapter: selectedChapter,
                userId: currentUser.uid,
                finalGrade: null,
                teacherFeedback: ""
            });
            setView('submitted');
        } catch (err) {
            alert("×©×’×™××” ×‘×©×œ×™×—×”: " + err.message);
            btn.disabled = false;
            btn.innerText = "×©×œ×— ××‘×—×Ÿ ×¡×•×¤×™ ×œ×‘×“×™×§×”";
        }
    }

    function renderSubmissionStatus() {
        const container = document.getElementById('submissionContent');
        const mySub = submissions.find(s => s.userId === currentUser.uid);
        
        if (!mySub) {
            container.innerHTML = `<p>×”××‘×—×Ÿ × ×©×œ×—. ×××ª×™×Ÿ ×œ×¡× ×›×¨×•×Ÿ...</p>`;
            return;
        }

        if (mySub.finalGrade !== null && mySub.finalGrade !== undefined) {
            container.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-200">
                    <p class="text-sm text-blue-600 font-bold mb-1">×”×¦×™×•×Ÿ ×©×œ×š:</p>
                    <p class="text-5xl font-black text-blue-800">${mySub.finalGrade}</p>
                    <div class="mt-4 pt-4 border-t border-blue-100 text-right">
                        <p class="font-bold text-slate-700">×”×¢×¨×•×ª ×”××•×¨×”:</p>
                        <p class="text-slate-600 italic">${mySub.teacherFeedback || '××™×Ÿ ×”×¢×¨×•×ª.'}</p>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="bg-yellow-50 p-6 rounded-2xl border border-yellow-200">
                    <p class="text-yellow-700 font-bold">×”××‘×—×Ÿ ×”×•×’×© ×‘×”×¦×œ×—×”!</p>
                    <p class="text-slate-600 text-sm mt-2">×”××•×¨×” ×˜×¨× ×‘×“×§ ××ª ×”××‘×—×Ÿ. ×‘×¨×’×¢ ×©×™×•×–×Ÿ ×¦×™×•×Ÿ, ×”×•× ×™×•×¤×™×¢ ×›××Ÿ.</p>
                </div>
            `;
        }
    }

    async function resetForNewTest() {
        const mySub = submissions.find(s => s.userId === currentUser.uid);
        if (mySub) {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×”×’×©×” ×”×§×•×“××ª ×•×œ×”×ª×—×™×œ ××—×“×©?")) {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').doc(mySub.id).delete();
                document.getElementById('quizForm').reset();
                selectedChapter = null;
                document.getElementById('chapterSection').classList.add('hidden');
                setView('quiz');
            }
        } else {
            setView('quiz');
        }
    }

    function handleTeacherAccess() {
        if (document.getElementById('passInput').value === TEACHER_PASSWORD) {
            setView('teacher');
        } else {
            alert("×¡×™×¡××” ×©×’×•×™×”");
        }
    }

    function renderSubmissionsTable() {
        const body = document.getElementById('submissionsTableBody');
        if (submissions.length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400 italic">×˜×¨× ×”×ª×§×‘×œ×• ×”×’×©×•×ª.</td></tr>';
            return;
        }
        body.innerHTML = submissions.map(s => `
            <tr class="border-b hover:bg-slate-50 transition">
                <td class="p-4 font-bold text-slate-800">${s.studentName}</td>
                <td class="p-4 text-slate-600 text-sm">${new Date(s.timestamp).toLocaleTimeString()}</td>
                <td class="p-4 text-center">×¤×¨×§ ${s.chapter}</td>
                <td class="p-4">
                    <span class="px-2 py-1 rounded-full text-xs font-bold ${s.finalGrade !== null ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                        ${s.finalGrade !== null ? '× ×‘×“×§' : '×××ª×™×Ÿ'}
                    </span>
                </td>
                <td class="p-4">
                    <button onclick="inspectSubmission('${s.id}')" class="bg-blue-600 text-white px-4 py-1 rounded-lg hover:bg-blue-700">×‘×“×•×§</button>
                </td>
            </tr>
        `).join('');
    }

    function inspectSubmission(id) {
        const sub = submissions.find(s => s.id === id);
        inspectingId = id;
        document.getElementById('submissionsList').classList.add('hidden');
        const panel = document.getElementById('gradingPanel');
        panel.classList.remove('hidden');
        
        panel.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">×‘×“×™×§×ª ××‘×—×Ÿ: ${sub.studentName}</h2>
                <button onclick="closeGrading()" class="text-slate-400 hover:text-red-500 text-2xl">âœ•</button>
            </div>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="max-h-[65vh] overflow-y-auto pr-2 space-y-6">
                    <h3 class="font-bold underline text-blue-700">×ª×©×•×‘×•×ª ×”×ª×œ××™×“:</h3>
                    ${Object.entries(sub.responses).map(([key, val]) => `
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <p class="text-xs text-slate-400 mb-1">${key}:</p>
                            <p class="text-slate-800">${val || '<i class="text-slate-300">×œ×œ× ×ª×©×•×‘×”</i>'}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-200 h-fit sticky top-0">
                    <h3 class="font-bold mb-4">×”×–× ×ª ×¦×™×•×Ÿ ×•××©×•×‘</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">×¦×™×•×Ÿ ×¡×•×¤×™:</label>
                            <input type="number" id="tGrade" value="${sub.finalGrade || ''}" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">×”×¢×¨×•×ª ×œ×‘×“×™×§×”:</label>
                            <textarea id="tFeedback" class="w-full h-32 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-400">${sub.teacherFeedback || ''}</textarea>
                        </div>
                        <button onclick="saveGrading()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 transition shadow-lg">×©××•×¨ ×•×©×œ×— ×¦×™×•×Ÿ ×œ×ª×œ××™×“</button>
                    </div>
                </div>
            </div>
        `;
    }

    function closeGrading() {
        document.getElementById('gradingPanel').classList.add('hidden');
        document.getElementById('submissionsList').classList.remove('hidden');
    }

    async function saveGrading() {
        const grade = document.getElementById('tGrade').value;
        const feedback = document.getElementById('tFeedback').value;
        try {
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('submissions').doc(inspectingId).update({
                finalGrade: grade === "" ? null : Number(grade),
                teacherFeedback: feedback
            });
            alert("×”×¦×™×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!");
            closeGrading();
        } catch (err) { alert("×©×’×™××” ×‘×©××™×¨×”: " + err.message); }
    }

    window.onload = initApp;
</script>

</body>
</html>
